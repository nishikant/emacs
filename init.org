#+TITLE: Emacs Configuration
#+PROPERTY: header-args:emacs-lisp :tangle ~/.emacs.d/settings.el

This is an ongoing evolution of my original Emacs configuration files,
inspired by a bunch of resources I've found online. Lot of it taken from https://github.com/MatthewZMD/.emacs.d

#+OPTIONS: toc: include all

* My Cheat Sheet
- Installation command:
  brew tap daviderestivo/emacs-head
  brew reinstall emacs-head@29 --with-dbus --with-multicolor-fonts --with-mailutils --with-cocoa --with-imagemagick --with-xwidgets --with-ctags --with-modern-icon-purple --with-native-comp --with-native-full-aot --bottle-arch
- C-i is tab
- C-M-k delete brackets and everything inside it
- C-u C-space move cursor to previous marked position
- C-x C-x move cursor to other end of selection
- Map CapsLock key to control
- C-x C-o delete blank lines delete-trailing-whitespace, tabify and untabify, indent-region, and so on.
- Keyboard Macros. General note, start at same position in new line
- C-x ( to start recording
- C-x ) to stop recording
- C-u 10 C-x e to execute 10 times
- C-c r search occurances in file
- C-x M-d to insert todays date
- C-u C-space to go back to previous position
- C-c left or C-c right to switch between window placement.
- C-x r w <key> and C-x r j <key> to store thin
- C-space C-x r k define a kill rectangle.
- C-t to open a terminal using shell-pop
- C-x C-m = M-x also C-c C-m just in case accidentally you use.
- C-x + to balance the split windows
- C-h backward delete char and remap help to M-h
- M-z zap-to-char
- M-/ hippie-expand for autocomplete, need (setq company-dabbrev-downcase nil) to work
- M-\ delete horizontal spaces
- C-x C-o Delete blank lines around the current line
- C-c C-j to switch terminal to line mode C-c C-k to move it back to character mod
- C-S-delete kill-whole-line
- M-r recenter-positions of cursor in current window
- C-M-a & C-M-e jump to beginning and end of paragraph/functions
- Lisp C-M-d & C-M-u move into or out of list
- C-M-f & C-M-b move back brackets or quotes
- C-M-S-v scroll-other-window-down C-M-S-n scroll-other-window up
- M-S-f/b <char> to select and <char> to insert around the selection, Add quotes around a word
- C-= select current region and it expands on multiple repeats
- C-c @ C-c/e Either hide or show the current block (hs-toggle-hiding).
- C-x C-n set-goal-column https://irreal.org/blog/?p=266
- OrgMode: C-c C-q add tag
- OrgMode: C-c C-x p add a property
- OrgMode: org-id-get-create
- OrgMode: C-ca to list all todos
- OrgMode:

* Package Management

Setup Melpa, org, gnu and elpa packaage repositories and load
use-package to manage package configuration.

#+begin_src emacs-lisp

  (setenv "LIBRARY_PATH"
          (let ((current (getenv "LD_LIBRARY_PATH"))
                (new "/usr/local/lib:/usr/local/Cellar/gcc/11.2.0/lib/gcc/11:/Library/Developer/CommandLineTools/usr/lib/llvm-gcc/4.2.1/"))
            (if current (concat new ":" current) new)))

  ;; Initialize package sources
  (require 'package)
  (setq package-archives '(("melpa" . "https://melpa.org/packages/")
                           ("elpa" . "https://elpa.gnu.org/packages/")
                           ("nongnuelpa" . "https://elpa.nongnu.org/nongnu/")
                           ("melpa-stable" . "https://stable.melpa.org/packages/")))
  (package-initialize)

  ;; Install use-package if not installed
  (unless (package-installed-p 'use-package)
    (package-refresh-contents)
    (package-install 'use-package))

  ;; Compile the latest versions
  (require 'use-package)
  (setq use-package-always-ensure t)

  (use-package use-package-ensure-system-package
    :ensure t)

  (cond
   ((string-equal system-type "darwin")
    (setq system-packages-use-sudo nil)
    (setq system-packages-package-manager 'brew)))

  (use-package auto-compile
    :config (auto-compile-on-load-mode))

  (use-package quelpa-use-package)
  (use-package quelpa)
  (require 'quelpa-use-package)
  (quelpa
   '(quelpa-use-package
     :fetcher github
     :url "https://github.com/quelpa/quelpa-use-package.git"))


  (add-to-list 'load-path "~/.emacs.d/site-lisp/")
  (add-to-list 'load-path "~/.emacs.d/quelpa/build/")

#+end_src

* Shortcuts
#+begin_src emacs-lisp

  ;; Unbind unneeded keys
  (global-set-key (kbd "C-z") nil)
  (global-set-key (kbd "M-z") nil)
  (global-set-key (kbd "M-m") nil)
  (global-set-key (kbd "C-x C-z") nil)
  (global-set-key (kbd "M-/") nil)
  ;; Truncate lines
  (global-set-key (kbd "C-x C-l") #'toggle-truncate-lines)
  ;; Adjust font size like web browsers
  (global-set-key (kbd "C-=") #'text-scale-increase)
  (global-set-key (kbd "C-+") #'text-scale-increase)
  (global-set-key (kbd "C--") #'text-scale-decrease)
  ;; Move up/down paragraph
  (global-set-key (kbd "M-n") #'forward-paragraph)
  (global-set-key (kbd "M-p") #'backward-paragraph)


  ;; (global-set-key (kbd "M-" 'just-one-space))
  ;; Meta-x also mapped C-x/c C-m
  (global-set-key "\C-x\C-m" 'execute-extended-command)
  (global-set-key "\C-c\C-m" 'execute-extended-command)

  ;; Use C-h instead of backspace and M-h for help
  (global-set-key "\C-h" 'delete-backward-char)
  (define-key isearch-mode-map "\C-h" 'isearch-delete-char)
  (global-set-key "\M-i" 'help-for-help)

  (global-set-key (kbd "C-f") 'forward-word)
  (global-set-key (kbd "C-b") 'backward-word)
  (global-set-key (kbd "M-f") 'forward-char)
  (global-set-key (kbd "M-b") 'backward-char)
  (global-set-key (kbd "M-/") 'hippie-expand)

  (global-set-key (kbd "C-M-S-n") 'scroll-other-window)

  (global-set-key (kbd "C-c C-f") 'aj-toggle-fold)
  (global-set-key (kbd "C-x M-d") 'insdate-insert-current-date)

  ;; After split move cursor to the split window automatically. Default keeps the cursor
  ;; in current window
  (global-set-key "\C-x2" (lambda () (interactive)(split-window-vertically) (other-window 1)))
  (global-set-key "\C-x3" (lambda () (interactive)(split-window-horizontally) (other-window 1)))
  (global-set-key (kbd "M-/") 'company-complete-common-or-cycle)
  (global-set-key (kbd "C-x o") 'ace-window) ;; switch window
  (global-set-key (kbd "C-M-v") 'View-scroll-half-page-forward)
  (global-set-key (kbd "C-M-n") 'View-scroll-half-page-backward)



  ;; multiple cursor & mark multiple
  (global-set-key (kbd "C-x r t") 'inline-string-rectangle)
  (global-set-key (kbd "C-<") 'mark-previous-like-this)
  (global-set-key (kbd "C->") 'mark-next-like-this)
  (global-set-key (kbd "C-M-m") 'mark-more-like-this) ; like the other two, but takes an argument (negative is previous)
  (global-set-key (kbd "C-*") 'mark-all-like-this)

  ;; (global-set-key (kbd "C-m C-m") 'mc/mark-all-dwim)
  (global-set-key (kbd "C-<") 'mc/mark-previous-like-this)
  (global-set-key (kbd "C->") 'mc/mark-next-like-this)
  (global-set-key (kbd "C-M->") 'mc/mark-more-like-this-extended)

  (global-set-key (kbd "C-.") 'hippie-expand-no-case-fold)
  (global-set-key (kbd "C-:") 'hippie-expand-lines)
  (global-set-key (kbd "C-,") 'completion-at-point)

  (global-set-key (kbd "C-x g") 'magit-status)



#+end_src

* Startup Performance

Make startup faster by reducing the frequency of garbage collection
and then use a hook to measure Emacs startup time.  For bug-hunter use
M-x bug-hunter-file and it will ask you path to tangled settings.el.

#+begin_src emacs-lisp

  ;; Bug hunter to debug errors in init.el.
  (use-package bug-hunter)

  (setq native-comp-speed 2
        comp-speed 2)
  (setq native-comp-async-report-warnings-errors nil
        comp-async-report-warnings-errors nil)
  (setq native-comp-async-query-on-exit t
        comp-async-query-on-exit t)

  (add-to-list 'default-frame-alist '(fullscreen . maximized))
  ;; The default is 800 kilobytes.  Measured in bytes.

  ;; Profile emacs startup
  (add-hook 'emacs-startup-hook
            (lambda ()
              (message "*** Emacs loaded in %s with %d garbage collections."
                       (format "%.2f seconds"
                               (float-time
                                (time-subtract after-init-time before-init-time)))
                       gcs-done)))
  ;; Increase garbage collector threshold
  (setq gc-cons-threshold (* 100 1000 1000))

  ;; Increase amount of data read from a process
  (setq read-process-output-max (* 2 1024 1024)) ;; 2 MB

  ;; change custom file location
  (setq custom-file (expand-file-name "custom.el" user-emacs-directory))
  (when (file-exists-p custom-file)
    (load custom-file))

  (use-package auto-package-update
    :ensure t
    :config
    (setq auto-package-update-delete-old-versions t)
    (auto-package-update-maybe))


  ;; So Long mitigates slowness due to extremely long lines.
  ;; Currently available in Emacs master branch *only*!
  (when (fboundp 'global-so-long-mode)
    (global-so-long-mode))

  ;; Better Compilation
  (setq-default compilation-always-kill t) ; kill compilation process before starting another

  (setq-default compilation-ask-about-save nil) ; save all buffers on `compile'

  (setq-default compilation-scroll-output t)

#+end_src
* Custom Functions
Custom functions that help in OrgMode and other functionality.
#+begin_src emacs-lisp

  ;; Custom Functions
  (defconst clangd-p
    (or (executable-find "clangd")  ;; usually
        (executable-find "/usr/local/opt/llvm/bin/clangd"))  ;; macOS
    "Do we have clangd?")
  ;; Set up before-save hooks to format buffer and add/delete imports.
  ;; Make sure you don't have other gofmt/goimports hooks enabled.

  (defun insdate-insert-current-date (&optional omit-day-of-week-p)
    "Insert today's date using the current locale.
      With a prefix argument, the date is inserted without the day of
      the week."
    (interactive "P*")
    (insert (calendar-date-string (calendar-current-date) nil
                                  omit-day-of-week-p)))

  (defun lsp-go-install-save-hooks ()
    "Save Hooks."
    (add-hook 'before-save-hook #'lsp-format-buffer t t)
    (add-hook 'before-save-hook #'lsp-organize-imports t t))

  (defun hrs/rename-file (new-name)
    "Rename file to NEW-NAME."
    (interactive "FNew name: ")
    (let ((filename (buffer-file-name)))
      (if filename
          (progn
            (when (buffer-modified-p)
              (save-buffer))
            (rename-file filename new-name t)
            (kill-buffer (current-buffer))
            (find-file new-name)
            (message "Renamed '%s' -> '%s'" filename new-name))
        (message "Buffer '%s' isn't backed by a file!" (buffer-name)))))

  (defun hrs/generate-scratch-buffer ()
    "Create and switch to a temporary scratch buffer with a random name."
    (interactive)
    (switch-to-buffer (make-temp-name "scratch-")))

  (defun hrs/kill-current-buffer ()
    "Kill the current buffer without prompting."
    (interactive)
    (kill-buffer (current-buffer)))

  (defun hrs/visit-last-migration ()
    "Open the most recent Rails migration.  Relies on projectile."
    (interactive)
    (let ((migrations
           (directory-files
            (expand-file-name "db/migrate" (projectile-project-root)) t)))
      (find-file (car (last migrations)))))

  (defun hrs/add-auto-mode (mode &rest patterns)
    "Add entries to `auto-mode-alist' to use `MODE' for all given file `PATTERNS'."
    (dolist (pattern patterns)
      (add-to-list 'auto-mode-alist (cons pattern mode))))

  (defun hrs/find-file-as-sudo ()
    "Search as sudo user."
    (interactive)
    (let ((file-name (buffer-file-name)))
      (when file-name
        (find-alternate-file (concat "/sudo::" file-name)))))

  (defun hrs/region-or-word ()
    "Camel case to separate word."
    (if mark-active
        (buffer-substring-no-properties (region-beginning)
                                        (region-end))
      (thing-at-point 'word)))

  (defun hrs/append-to-path (path)
    "Add a path both to the PATH variable and to Emacs' `exec-path'."
    (setenv "PATH" (concat (getenv "PATH") ":" path))
    (add-to-list 'exec-path path))

  (defun hrs/insert-password ()
    "Insert password."
    (interactive)
    (shell-command "pwgen 30 -1" t))

  (defun hrs/notify-send (title message)
    "Display a desktop notification by shelling out to `notify-send' TITLE MESSAGE."
    (call-process-shell-command
     (format "notify-send -t 2000 \"%s\" \"%s\"" title message)))

  (defun aj-toggle-fold ()
    "Toggle fold all lines larger than indentation on current line"
    (interactive)
    (let ((col 1))
      (save-excursion
        (back-to-indentation)
        (setq col (+ 1 (current-column)))
        (set-selective-display
         (if selective-display nil (or col 1))))))


#+end_src

* System Settings

Some basic settings around how emacs should look and behave. Like no
scroll bar, async support,etc.

#+begin_src emacs-lisp
  (use-package discover-my-major)

  (use-package crux
    :bind
    (("C-a" . crux-move-beginning-of-line)
     ("C-x 4 t" . crux-transpose-windows)
     ("C-x K" . crux-kill-other-buffers)
     ("C-k" . crux-smart-kill-line))
    :config
    (crux-with-region-or-buffer indent-region)
    (crux-with-region-or-buffer untabify)
    (crux-with-region-or-point-to-eol kill-ring-save)
    (defalias 'rename-file-and-buffer #'crux-rename-file-and-buffer))
  (setq company-dabbrev-downcase nil)
  (setq load-prefer-newer t)
  (setq kill-whole-line t)

  ;; stretch the cursor width to character size
  (setq x-stretch-cursor t)
  ;; Create all backup files in ~/.emacs.d/
  (setq backup-directory-alist '(("." . "~/.emacs.d/backup"))
        backup-by-copying t    ; Don't delink hardlinks
        version-control t      ; Use version numbers on backups
        delete-old-versions t  ; Automatically delete excess backups
        kept-new-versions 20   ; how many of the newest versions to keep
        kept-old-versions 5    ; and how many of the old
        )

  ;; Disable menu and scroll bars
  ;; (setq debug-on-error t)
  ;; (tool-bar-mode -1)
  (menu-bar-mode -1)
  (scroll-bar-mode -1)

  (set-window-scroll-bars (minibuffer-window) nil nil)

  ;; Set default frame title
  ;;  (setq frame-title-format '((:eval (projectile-project-name))))
  (setq delete-auto-save-files t)
  (setq delete-old-versions t)
  (setq global-semantic-folding-mode t)

  (add-hook 'before-save-hook 'whitespace-cleanup)

  ;; Replace selection on insert
  (delete-selection-mode 1)

  ;; Map Alt key to Meta
  (setq x-alt-keysym 'meta)
  (setq mac-command-modifier 'meta)

  ;; getting rid of the "yes or no" prompt and replace it with "y or n"
  (defalias 'yes-or-no-p 'y-or-n-p)

  (setq inhibit-splash-screen t) ;; no splash screen
  (setq-default indent-tabs-mode nil)      ;; no tabs!
  (setq fill-column 80) ;; M-q should fill at 80 chars, not 75
  (setq initial-buffer-choice "~/Documents/org-roam/work.org") ;; make the eng log the first file that's open.

  ;; async enables basic async capabilities for emacs

  (use-package async
    :init
    (autoload 'dired-async-mode "dired-async.el" nil t)
    (dired-async-mode 1)
    (async-bytecomp-package-mode 1)

    (require 'smtpmail-async)
    (setq send-mail-function 'async-smtpmail-send-it))
  (setq async-shell-command-buffer 'new-buffer)
  ;; sometimes desktop is locked, ask if we want to load it.
  (setq desktop-load-locked-desktop "ask")

  ;; auto-save buffer state on close for a later time.
  ;; (desktop-save-mode 1)

  ;; Abbrevs expands abbreviations

  (setq abbrev-file-name             ;; tell emacs where to read abbrev
        "~/project/emacs/abbrev_defs")    ;; definitions from...

  ;; default directory
  (setq default-directory "~/")

  ;; Dont show minor modes in mode line
  (use-package diminish)

  ;; disable startup message
  (setq inhibit-startup-message t)

  ;; disable beep sound
  (setq ring-bell-function 'ignore)

  ;; disable confirmation if a file or buffer does not exist when you
  ;; use C-x C-f or C-x b
  (setq confirm-nonexistent-file-or-buffer nil)

  ;; disable confirmation when kill a buffer with a live process
  ;; attached to it
  (setq kill-buffer-query-functions
        (remq 'process-kill-buffer-query-function
              kill-buffer-query-functions))

  ;; use trash
  (setq delete-by-moving-to-trash t)

  ;; undo-tree (need to explore)
  (use-package undo-tree
    :diminish undo-tree-mode
    :config
    (global-undo-tree-mode 1))


  ;; whole-line-ore-region use currentline if no region is selected.
  ;; primarily used to cut currentline if no region is defined
  (use-package whole-line-or-region
    :ensure t
    :diminish whole-line-or-region-global-mode
    :config
    (whole-line-or-region-global-mode 1))


  ;; switch-window gives a visual indicator when switching windows.
  (use-package ace-window)

  ;; expand-region expand selection of your region
  (use-package expand-region
    :ensure t
    :config
    (bind-key* "C-=" 'er/expand-region))

  ;; set line number
  (when (version<= "26.0.50" emacs-version )
    (global-display-line-numbers-mode))

  (setq ffap-require-prefix nil)
  (ffap-bindings)
  (setq ffap-require-prefix t)

  (use-package use-package-hydra)
  (use-package hydra
    :ensure t)
  (use-package which-key :config (which-key-mode))

  ;; Optional - provides snippet support.

  (use-package yasnippet
    :diminish yas-minor-mode
    :init
    (use-package yasnippet-snippets :after yasnippet)
    :hook ((prog-mode LaTeX-mode org-mode) . yas-minor-mode)
    :bind
    (:map yas-minor-mode-map ("C-c C-n" . yas-expand-from-trigger-key))
    (:map yas-keymap
          (("TAB" . smarter-yas-expand-next-field)
           ([(tab)] . smarter-yas-expand-next-field)))
    :config
    (yas-reload-all)
    (defun smarter-yas-expand-next-field ()
      "Try to `yas-expand' then `yas-next-field' at current cursor position."
      (interactive)
      (let ((old-point (point))
            (old-tick (buffer-chars-modified-tick)))
        (yas-expand)
        (when (and (eq old-point (point))
                   (eq old-tick (buffer-chars-modified-tick)))
          (ignore-errors (yas-next-field))))))
  (yas-global-mode 1)
  (define-key yas-minor-mode-map (kbd "<tab>") nil)
  (define-key yas-minor-mode-map (kbd "TAB") nil)
  (define-key yas-minor-mode-map (kbd "<C-tab>") 'yas-expand)


  ;; fuzzy search
  (use-package fzf)

  ;; Drag line up/down M-up, M-down, M-left, M-right comes because of this
  (use-package drag-stuff)
  (require 'drag-stuff)
  (drag-stuff-global-mode 1)
  (drag-stuff-define-keys)

  ;; winner mode to handle windows config rollback

  (use-package winner
    :ensure nil
    :custom
    (winner-boring-buffers
     '("*Completions*"
       "*Compile-Log*"
       "*inferior-lisp*"
       "*Fuzzy Completions*"
       "*Apropos*"
       "*Help*"
       "*cvs*"
       "*Buffer List*"
       "*Ibuffer*"
       "*esh command on file*"))
    :config
    (winner-mode 1))


  ;; Outline for code folding
  ;; Outline-minor-mode key map
  (define-prefix-command 'cm-map nil "Outline-")

                                          ; Hide
  (define-key cm-map "q" 'outline-hide-sublevels)    ; Hide everything but the top-level headings
  (define-key cm-map "t" 'outline-hide-body)         ; Hide everything but headings (all body lines)
  (define-key cm-map "o" 'outline-hide-other)        ; Hide other branches
  (define-key cm-map "c" 'outline-hide-entry)        ; Hide this entry's body
  (define-key cm-map "l" 'outline-hide-leaves)       ; Hide body lines in this entry and sub-entries
  (define-key cm-map "d" 'outline-hide-subtree)      ; Hide everything in this entry and sub-entries
  ;; Show
  (define-key cm-map "a" 'outline-show-all)          ; Show (expand) everything
  (define-key cm-map "e" 'outline-show-entry)        ; Show this heading's body
  (define-key cm-map "i" 'outline-show-children)     ; Show this heading's immediate child sub-headings
  (define-key cm-map "k" 'outline-show-branches)     ; Show all sub-headings under this heading
  (define-key cm-map "s" 'outline-show-subtree)      ; Show (expand) everything in this heading & below

  (define-key cm-map "u" 'outline-up-heading)                ; Up
  (define-key cm-map "n" 'outline-next-visible-heading)      ; Next
  (define-key cm-map "p" 'outline-previous-visible-heading)  ; Previous
  (define-key cm-map "f" 'outline-forward-same-level)        ; Forward - same level
  (define-key cm-map "b" 'outline-backward-same-level)       ; Backward - same level
  (global-set-key "\M-o" cm-map)
  (setq ac-ignore-case nil)

#+end_src

** OS Specific

OS specific settings to make things work

#+begin_src emacs-lisp

  (use-package exec-path-from-shell
    :ensure t
    :config
    (exec-path-from-shell-initialize)
    (if (and (fboundp 'native-comp-available-p)
             (native-comp-available-p))
        (progn
          (message "Native comp is available")
          ;; Using Emacs.app/Contents/MacOS/bin since it was compiled with
          ;; ./configure --prefix="$PWD/nextstep/Emacs.app/Contents/MacOS"
          (add-to-list 'exec-path (concat invocation-directory "bin") t)
          (setenv "LIBRARY_PATH" (concat (getenv "LIBRARY_PATH")
                                         (when (getenv "LIBRARY_PATH")
                                           ":")
                                         ;; This is where Homebrew puts gcc libraries.
                                         (car (file-expand-wildcards
                                               (expand-file-name "~/homebrew/opt/gcc/lib/gcc/*")))))
          ;; Only set after LIBRARY_PATH can find gcc libraries.
          (setq comp-deferred-compilation t))
      (message "Native comp is *not* available")))
  ;; Mac OSX specific settings


#+end_src

* Beautify emacs

Themes and other configuration

#+begin_src emacs-lisp


  (display-time-mode 1)
  (display-battery-mode 1)



  (use-package aggressive-indent
    :disabled
    :diminish aggressive-indent-mode
    :hook
    (prog-mode . aggressive-indent-mode)
    (python-mode . (lambda () (aggressive-indent-mode -1))))

  ;; File beautification

  (use-package all-the-icons-ivy-rich
    :ensure t
    :init (all-the-icons-ivy-rich-mode 1))

  (setq-default truncate-lines 1) ;; no wordwrap
  (use-package rainbow-mode
    :diminish rainbow-mode
    )
  ;; electric-pair-mode
  (electric-pair-mode 1)
  (show-paren-mode 1)
  ;; highlight indentation
  (use-package highlight-indent-guides)
  (add-hook 'prog-mode-hook 'highlight-indent-guides-mode)
  (setq highlight-indent-guides-method 'character)
  (use-package viewer)

  ;; Code folding
  (use-package hideshow
    :hook ((prog-mode . hs-minor-mode)))

  ;; Use fancy lambdas
  (global-prettify-symbols-mode t)

  ;; buffernames that are foo<1>, foo<2> are hard to read. This makes them foo|dir  foo|otherdir
  (require 'uniquify)
  (setq uniquify-buffer-name-style 'post-forward)

  ;; colorize the output of the compilation mode.
  (require 'ansi-color)
  (defun colorize-compilation-buffer ()
    (toggle-read-only)
    (ansi-color-apply-on-region (point-min) (point-max))

    ;; mocha seems to output some non-standard control characters that
    ;; aren't recognized by ansi-color-apply-on-region, so we'll
    ;; manually convert these into the newlines they should be.
    (goto-char (point-min))
    (while (re-search-forward "\\[2K\\[0G" nil t)
      (progn
        (replace-match "")))
    (toggle-read-only))
  (add-hook 'compilation-filter-hook 'colorize-compilation-buffer)


  ;; making tooltips appear in the echo area
  (tooltip-mode 0)

  ;; highlight current line
  (global-hl-line-mode)
  (set-face-background hl-line-face "gray13")
  (set-face-attribute 'default nil :height 140)

  ;; display column number in mode line
  (column-number-mode 1)

  ;; show buffer file name in title bar
  (setq frame-title-format
        '((:eval (if (buffer-file-name)
                     (abbreviate-file-name (buffer-file-name))
                   "%b"))))

  ;; Sidebar

  (use-package dired-toggle
    :defer t
    :bind (("<f3>" . #'dired-toggle)
           :map dired-mode-map
           ("q" . #'dired-toggle-quit)
           ([remap dired-find-file] . #'dired-toggle-find-file)
           ([remap dired-up-directory] . #'dired-toggle-up-directory)
           ("C-c C-u" . #'dired-toggle-up-directory))
    :config
    (setq dired-toggle-window-size 32)
    (setq dired-toggle-window-side 'left)

    ;; Optional, enable =visual-line-mode= for our narrow dired buffer:
    (add-hook 'dired-toggle-mode-hook
              (lambda () (interactive)
                (visual-line-mode 1)
                (setq-local visual-line-fringe-indicators '(nil right-curly-arrow))
                (setq-local word-wrap nil))))

  (use-package rainbow-delimiters
    :config
    (add-hook 'prog-mode-hook #'rainbow-delimiters-mode))

#+end_src

* Editing
#+begin_src emacs-lisp

  (use-package mark-multiple )
  (require 'inline-string-rectangle)
  (require 'mark-more-like-this)

  (use-package multiple-cursors
    :diminish multiple-cursors-mode
    )
  (require 'multiple-cursors)

  (add-hook 'sgml-mode-hook
            (lambda ()
              (require 'rename-sgml-tag)
              (define-key sgml-mode-map (kbd "C-c C-r") 'rename-sgml-tag)))

  ;;Iedit, a minor mode that allows editing multiple regions simultaneousy in a buffer or a region.

  (use-package iedit
    :bind ("C-x ," . iedit-mode)
    :diminish)

  ;; Conf Mode, a simple major mode for editing conf/ini/properties files.

  (use-package conf-mode
    :ensure nil
    :bind
    (:map conf-mode-map
          (("M-D" . awesome-pair-kill)
           ("SPC" . awesome-pair-space)
           ("=" . awesome-pair-equal)
           ("M-F" . awesome-pair-jump-right)
           ("M-B" . awesome-pair-jump-left))))

  ;; Smartparens, a minor mode for dealing with pairs.

  (use-package smartparens
    :hook (prog-mode . smartparens-mode)
    :diminish smartparens-mode
    :bind
    (:map smartparens-mode-map
          ("C-M-f" . sp-forward-sexp)
          ("C-M-b" . sp-backward-sexp)
          ("C-M-a" . sp-backward-down-sexp)
          ("C-M-e" . sp-up-sexp)
          ("C-M-w" . sp-copy-sexp)
          ("C-M-k" . sp-change-enclosing)
          ("M-k" . sp-kill-sexp)
          ("C-M-<backspace>" . sp-splice-sexp-killing-backward)
          ("C-S-<backspace>" . sp-splice-sexp-killing-around))
    :custom
    (sp-escape-quotes-after-insert nil)
    :config
    ;; Stop pairing single quotes in elisp
    (sp-local-pair 'emacs-lisp-mode "'" nil :actions nil)
    (sp-local-pair 'org-mode "[" nil :actions nil))

  (require 'smartparens-config)
  (smartparens-global-mode t)

#+end_src


* Active Theme

Configuration for currently used theme

#+begin_src emacs-lisp

  ;; Themes
  (use-package solarized-theme)
  (load-theme 'solarized-dark t)
  (defun transparency (value)
    "VALUE Set the transparency of the frame window.  0=transparent/100=opaque."
    (interactive "nTransparency Value 0 - 100 opaque:")
    (set-frame-parameter (selected-frame) 'alpha value))

  (defun apply-theme ()
    "Apply the `solarized-light' theme and make frames just slightly transparent."
    (interactive)
    (load-theme 'solarized-dark t)
    (transparency 89))

  ;; wombat color-theme with misc face definition
  (solarized-create-theme-file-with-palette 'dark 'solarized-wombat-dark
    '("#2a2a29" "#f6f3e8"
      "#e5c06d" "#ddaa6f" "#ffb4ac" "#e5786d" "#834c98" "#a4b5e6" "#7ec98f" "#8ac6f2")
    '((custom-theme-set-faces
       theme-name
       `(default ((,class (:foreground ,(solarized-color-blend base03 base3 0.15 2) :background ,base03))))
       `(highlight ((,class (:background ,violet))))
       `(font-lock-builtin-face ((,class (:foreground ,magenta))))
       `(font-lock-constant-face ((,class (:foreground ,blue))))
       `(font-lock-comment-face ((,class (:foreground ,base00))))
       `(mode-line
         ((,class (:foreground ,base2 :background ,(solarized-color-blend base03 base3 0.85 2)))))
       `(mode-line-inactive
         ((,class (:foreground ,base00 :background ,(solarized-color-blend base03 "black" 0.85 2)))))
       `(mode-line-buffer-id ((,class (:foreground ,base3 :weight bold))))
       `(minibuffer-prompt ((,class (:foreground ,base1))))
       `(vertical-border ((,class (:foreground ,base03)))))))

  (load-theme 'solarized-dark t)

  ;; Apply theme in emacs --daemon mode
  (if (daemonp)
      (add-hook 'after-make-frame-functions
                (lambda (frame)
                  (with-selected-frame frame (apply-theme))))
    (apply-theme))

  ;; use moody for a beautiful modeline

  (use-package moody
    :config
    (setq x-underline-at-descent-line t)
    (setq moody-mode-line-height 30)
    (moody-replace-mode-line-buffer-identification)
    (moody-replace-vc-mode))

  ;; hide minor modes
  (use-package minions
    :config
    (setq minions-mode-line-lighter ""
          minions-mode-line-delimiters '("" . ""))
    (minions-mode 1))

  ;; Scroll conservatively

  (setq scroll-conservatively 100)


#+end_src

* Code
** Global
Coding related global settings

#+begin_src emacs-lisp

  ;; Highlight uncommitted changes

  (use-package diff-hl
    :config
    (add-hook 'prog-mode-hook 'turn-on-diff-hl-mode)
    (add-hook 'vc-dir-mode-hook 'turn-on-diff-hl-mode))
  (global-diff-hl-mode)

  ;; When saving a file that starts with `#!', make it executable.
  (add-hook 'after-save-hook
            'executable-make-buffer-file-executable-if-script-p)

  ;; to suppress -Chg in mode line
  (use-package hilit-chg
    :diminish highlight-changes-mode)

  ;;  (global-highlight-changes-mode t)


  ;; Test tab-width 2
  (setq-default tab-width 4)

  ;; Words like HelloWorld are handled by subword
  (use-package subword
    :config (global-subword-mode 1))

  (subword-mode +1)

  ;; Compilation scrolling modes

  (setq compilation-scroll-output t)
  ;;  (setq compilation-scroll-output 'first-error)

  ;; ws-butler an unobtrusive way to trim spaces from end of line
  (use-package ws-butler
    :ensure t
    :diminish ws-butler-mode
    :config
    (add-hook 'prog-mode-hook 'ws-butler-mode)
    (add-hook 'jinja2-mode-hook 'ws-butler-mode)
    (add-hook 'rst-mode-hook 'ws-butler-mode)
    (add-hook 'yaml-mode-hook 'ws-butler-mode)
    (add-hook 'protobuf-mode-hook 'ws-butler-mode))
  ( ws-butler-global-mode)

  (use-package ivy-xref
    :ensure t
    :init
    ;; xref initialization is different in Emacs 27 - there are two different
    ;; variables which can be set rather than just one
    (when (>= emacs-major-version 27)
      (setq xref-show-definitions-function #'ivy-xref-show-defs))
    ;; Necessary in Emacs <27. In Emacs 27 it will affect all xref-based
    ;; commands other than xref-find-definitions (e.g. project-find-regexp)
    ;; as well
    (setq xref-show-xrefs-function #'ivy-xref-show-xrefs))

#+end_src
*** Completion
Using Counsel and ivy to code completion

#+begin_src emacs-lisp

  ;; Counsel

  (setq recentf-max-saved-items 100)

  (global-set-key "\C-cq" #'bury-buffer)

  (use-package flx
    :after ivy)

  (use-package counsel
    :demand
    :init
    (setq ivy-use-virtual-buffers t
          ivy-re-builders-alist
          '((counsel-git-grep . ivy--regex-plus)
            (counsel-rg . ivy--regex-plus)
            (swiper . ivy--regex-plus)
            (swiper-all . ivy--regex-plus)
            (t . ivy--regex-fuzzy)))
    :config
    (add-to-list 'ivy-ignore-buffers "\\`\\*remind-bindings\\*")
    (ivy-mode 1)
    (counsel-mode 1)
    :bind
    (("C-c E" . counsel-flycheck)
     ("C-c f" . counsel-fzf)
     ("C-c g" . counsel-git)
     ("C-c j" . counsel-git-grep)
     ("C-c L" . counsel-locate)
     ("C-c o" . counsel-outline)
     ("C-c r" . counsel-rg)
     ("C-c R" . counsel-register)
     ("C-c T" . counsel-load-theme)))

  (use-package ivy-posframe
    :init
    (setq ivy-posframe-display-functions-alist
          '((t . ivy-posframe-display-at-frame-center)))
    :config
    (ivy-posframe-mode 1))


#+end_src
*** LSP Mode
LSP mode settings. Custom language settings also included here.

#+begin_src emacs-lisp

  ;; LSP mode
  (use-package lsp-mode
    :ensure t
    :commands (lsp lsp-deferred)
    ;; reformat code and add missing (or remove old) imports
    :hook ((before-save . lsp-organize-imports)
           (python-mode . lsp-deferred)
           (groovy-mode . lsp-deferred)
           (go-mode . lsp-deferred)
           (java-mode . lsp-deferred)
           (csharp-mode . lsp-deferred)
           (sh-mode . lsp-deferred)
           (yaml-mode . lsp-deferred)
           (cfn-yaml-mode . lsp-deferred)
           (web-mode . lsp-deferred)
           ((js2-mode rjsx-mode) . lsp-deferred)
           (lsp-mode . lsp-enable-which-key-integration))
    :bind (("C-c d" . lsp-describe-thing-at-point)
           ("C-c e n" . flymake-goto-next-error)
           ("C-c e p" . flymake-goto-prev-error)
           ("C-c e r" . lsp-find-references)
           ("C-c e R" . lsp-rename)
           ("C-c e i" . lsp-find-implementation)
           ("C-c e t" . lsp-find-type-definition)
           )
    :ensure-system-package
    ((node)
     (typescript-language-server . "npm install -g typescript-language-server")
     (javascript-typescript-langserver . "npm install -g javascript-typescript-langserver")
     (bash-language-server . "npm install -g bash-language-server")
     (python-lsp-server . "pip3 install python-lsp-server[all]")
     (jedi . "pip3 install jedi")
     (tsc . "npm install -g typescript")
     (golang)
     (pylib . "pip3 install pandas matplotlib sklearn torch ipykernel tensorflow torchvision --upgrade")
     (gopls . "GOBIN=/Users/gattu/go/bin GO111MODULE=on go install golang.org/x/tools/gopls@latest"))

    :config
    (setq lsp-modeline-diagnostics-scope :workspace)
    (setq lsp-headerline-breadcrumb-enable t)
    (setq lsp-enable-snippet t)
    (setq lsp-file-watch-threshold 4000)
    (setq lsp-headerline-breadcrumb-mode t)

    (setq lsp-semantic-highlighting 'immediate)
    (setq lsp-clients-go-library-directories '("/Users/gattu/project/go/"))
    (setq lsp-enable-semantic-highlighting t)
    (lsp-register-custom-settings
     '(("gopls.completeUnimported" t t)
       ("gopls.staticcheck" t t)
       ;; ("gopls.experimentalWorkspaceModule" t t)
       )))
  (setq lsp-eldoc-render-all t)
  ;; Optional - provides fancier overlays.
  (use-package lsp-ui
    :ensure t
    :after (lsp-mode)
    :commands lsp-ui-doc-hide
    :bind (:map lsp-ui-mode-map
                ([remap xref-find-definitions] . lsp-ui-peek-find-definitions)
                ([remap xref-find-references] . lsp-ui-peek-find-references)
                ("C-c u" . lsp-ui-imenu))
    :init (setq lsp-ui-doc-enable t
                lsp-ui-doc-use-webkit nil
                lsp-ui-doc-header nil
                lsp-ui-doc-delay 0.1
                lsp-ui-doc-frame t
                lsp-ui-doc-show-with-cursor t
                lsp-ui-doc-include-signature t
                lsp-ui-doc-alignment 'frame
                lsp-ui-doc-use-childframe nil
                lsp-ui-doc-border (face-foreground 'default)
                lsp-ui-peek-enable t
                lsp-ui-peek-show-directory t
                lsp-ui-sideline-update-mode 'point
                lsp-ui-sideline-enable t
                lsp-ui-sideline-show-code-actions t
                lsp-ui-sideline-show-diagnostics t
                lsp-ui-sideline-show-hover t
                lsp-ui-sideline-ignore-duplicate t)
    :config
    (add-to-list 'lsp-ui-doc-frame-parameters '(right-fringe . 8))

    ;; `C-g'to close doc
    (advice-add #'keyboard-quit :before #'lsp-ui-doc-hide)

    ;; Reset `lsp-ui-doc-background' after loading theme
    (add-hook 'after-load-theme-hook
              (lambda ()
                (setq lsp-ui-doc-border (face-foreground 'default))
                (set-face-background 'lsp-ui-doc-background
                                     (face-background 'tooltip))))

    ;; WORKAROUND Hide mode-line of the lsp-ui-imenu buffer
    ;; @see https://github.com/emacs-lsp/lsp-ui/issues/243
    (defadvice lsp-ui-imenu (after hide-lsp-ui-imenu-mode-line activate)
      (setq mode-line-format nil)))

  ;; company-lsp integrates company mode completion with lsp-mode.
  ;; completion-at-point also works out of the box but doesn't support snippets.
  ;; uses the given recipe

#+end_src

#+RESULTS:
*** DAP Mode

Debug settings for various languages

#+begin_src emacs-lisp

  ;; DAP mode
  (use-package dap-java :ensure nil)
  (use-package lsp-java :config (add-hook 'java-mode-hook 'lsp))
  (use-package dap-mode
    :diminish dap-mode
    :ensure t
    :after (lsp-mode)
    :config
    (dap-mode 1)
    (dap-auto-configure-mode)
    (setq dap-print-io t)
    (require 'dap-hydra)
    (require 'dap-java)
    (require 'dap-python)
    (require 'dap-lldb)
    (require 'dap-firefox)
    (require 'dap-chrome)
    (require 'dap-node)
    (require 'dap-gdb-lldb)
    (require 'dap-go)   ;  (require 'dap-go)		; download and expand vscode-go-extenstion to the =~/.extensions/go=
    (dap-go-setup)
    (dap-chrome-setup)
    (use-package dap-ui
      :ensure nil
      :config
      (dap-ui-mode 1)))


  ;; Rust template
  (require 'dap-mode)
  (dap-register-debug-template "Rust::GDB Run Configuration"
                               (list :type "gdb"
                                     :request "launch"
                                     :name "GDB::Run"
                                     :gdbpath "rust-gdb"
                                     :target nil
                                     :cwd nil))

  ;; JavaRunner
  (dap-register-debug-template "JavaRunner"
                               (list :type "java"
                                     :request "launch"
                                     :args ""
                                     :vmArgs "-ea -Dmyapp.instance.name=myapp_1"
                                     :projectName "myapp"
                                     :mainClass "com.domain.AppRunner"
                                     :env '(("DEV" . "1"))))

  ;; Python template

  (dap-register-debug-template "My App"
                               (list :type "python"
                                     :args "-i"
                                     :cwd nil
                                     :env '(("DEBUG" . "1"))
                                     :target-module (expand-file-name "~/src/myapp/.env/bin/myapp")
                                     :request "launch"
                                     :name "My App"))

  (setq dap-auto-configure-features '(sessions locals controls tooltip))
  ;; The modes above are optional

  ;; enables mouse hover support
  (dap-tooltip-mode 1)
  ;; use tooltips for mouse hover
  ;; if it is not enabled `dap-mode' will use the minibuffer.
  (tooltip-mode 1)
  ;; displays floating panel with debug buttons
  ;; requies emacs 26+
  (dap-ui-controls-mode 1)

#+end_src

#+begin_src emacs-lisp

;;Don't use strange separate control-window.
(customize-set-variable 'ediff-window-setup-function 'ediff-setup-windows-plain)

;;Side by side comparison is easier than vertical split
;;(tob-bottom-stacked) window
(customize-set-variable 'ediff-split-window-function 'split-window-horizontally)

;; ;; To ignore white space. Note: not good for Python
;; (csetq ediff-diff-options "-w")

;; reset the window configuration after ediff is done
;;(winner-mode)
;;(add-hook 'ediff-after-quit-hook-internal 'winner-undo)

#+end_src** Ediff

See diff of two files


** Graphics

Epaint
#+begin_src emacs-lisp
  (use-package epaint
    :if (display-graphic-p)
    :load-path (lambda () (expand-file-name "site-elisp/epaint" user-emacs-directory))
    :commands (epaint)
    :init
    (with-eval-after-load (quote epaint-context)
      (unless (boundp (quote cl-struct-epaint-drawable))
        (defvar cl-struct-epaint-drawable (quote epaint-drawable)))
      (unless (boundp (quote cl-struct-epaint-gc))
        (defvar cl-struct-epaint-gc (quote epaint-gc)))))



  (use-package leetcode
    :load-path (lambda () (expand-file-name "site-elisp/leetcode.el" user-emacs-directory))
    :commands (leetcode)
    :init
    (use-package graphql :defer t)
    (use-package aio :defer t)
    :custom
    (url-debug t)
    (leetcode-prefer-language "python3"))


#+end_src

** FlyCheck
Use fly check to check syntax
#+begin_src emacs-lisp


  ;; flycheck

  (use-package flycheck
    :defer t
    :diminish
    :hook (after-init . global-flycheck-mode)
    :commands (flycheck-add-mode)
    :custom
    (flycheck-global-modes
     '(not outline-mode diff-mode shell-mode eshell-mode term-mode))
    (flycheck-emacs-lisp-load-path 'inherit)
    (flycheck-indication-mode (if (display-graphic-p) 'right-fringe 'right-margin))
    :init
    (if (display-graphic-p)
        (use-package flycheck-posframe
          :custom-face
          (flycheck-posframe-face ((t (:foreground ,(face-foreground 'success)))))
          (flycheck-posframe-info-face ((t (:foreground ,(face-foreground 'success)))))
          :hook (flycheck-mode . flycheck-posframe-mode)
          :custom
          (flycheck-posframe-position 'window-bottom-left-corner)
          (flycheck-posframe-border-width 3)
          (flycheck-posframe-inhibit-functions
           '((lambda (&rest _) (bound-and-true-p company-backend)))))
      (use-package flycheck-pos-tip
        :defines flycheck-pos-tip-timeout
        :hook (flycheck-mode . flycheck-pos-tip-mode)
        :custom (flycheck-pos-tip-timeout 30)))
    :config

    (setq flycheck-check-syntax-automatically '(mode-enabled save))
    (setq compilation-auto-jump-to-first-error t)
    (add-hook 'python-mode-hook 'flycheck-mode)
    (add-hook 'go-mode-hook 'flycheck-mode)
    (add-hook 'sh-mode-hook 'flycheck-mode)
    (add-hook 'rst-mode-hook 'flycheck-mode)
    (add-hook 'js2-mode-hook 'flycheck-mode)
    (add-hook 'web-mode-hook 'flycheck-mode)
    (add-hook 'elpy-mode-hook 'flycheck-mode)
    (use-package flycheck-popup-tip
      :hook (flycheck-mode . flycheck-popup-tip-mode))
    (when (fboundp 'define-fringe-bitmap)
      (define-fringe-bitmap 'flycheck-fringe-bitmap-double-arrow
        [16 48 112 240 112 48 16] nil nil 'center))
    (when (executable-find "vale")
      (use-package flycheck-vale
        :config
        (flycheck-vale-setup)
        (flycheck-add-mode 'vale 'latex-mode))))

  (use-package flyspell
    :ensure nil
    :diminish
    :if (executable-find "aspell")
    :hook (((text-mode outline-mode latex-mode org-mode markdown-mode) . flyspell-mode))
    :custom
    (flyspell-issue-message-flag nil)
    (ispell-program-name "aspell")
    (ispell-extra-args
     '("--sug-mode=ultra" "--lang=en_US" "--camel-case"))
    :config
    (use-package flyspell-correct-ivy
      :after ivy
      :bind
      (:map flyspell-mode-map
            ([remap flyspell-correct-word-before-point] . flyspell-correct-wrapper)
            ("C-." . flyspell-correct-wrapper))
      :custom (flyspell-correct-interface #'flyspell-correct-ivy)))





#+end_src

** Git

Using Magit to handle all git related stuff.
#+begin_src emacs-lisp

  ;; magit
  (use-package git-timemachine)
  (use-package magit
    :ensure t
    :config
    (setq magit-completing-read-function 'ivy-completing-read)
    :diminish auto-revert-mode)

  ;; gitignore-mode
  (use-package git-modes
    :ensure t
    :config
    (add-hook 'gitignore-mode-hook (lambda ()
                                     (setq require-final-newline t))))


#+end_src

** Search what to use rg/ag/grep?

Intelligent Search

#+begin_src emacs-lisp


  ;; ripgrep
  (use-package rg
    :ensure-system-package (ripgrep))

  (require 'rg)
  (rg-enable-default-bindings)
  (setq rg-align-position-numbers t)
  (setq rg-align-line-number-field-length 3)
  (setq rg-align-column-number-field-length 3)
  (setq rg-align-line-column-separator "#")
  (setq rg-align-position-content-separator "|")
  (setq rg-command-line-flags '("--hidden"))
  (setq rg-default-alias-fallback '("everything"))
  (setq rg-custom-type-aliases '(("everything" . "*")))


#+end_src

** Code completion

Use Ivy frame work for code completion interface

#+begin_src emacs-lisp

  ;; ivy

  (use-package ivy
    :diminish
    :init
    (use-package amx :defer t)
    (use-package counsel :diminish :config (counsel-mode 1))
    (use-package swiper :defer t)
    (ivy-mode 1)
    :bind
    (("C-s" . swiper)
     ("C-z s" . counsel-rg)
     ("C-z b" . counsel-buffer-or-recentf)
     ("C-z C-b" . counsel-ibuffer)
     (:map ivy-minibuffer-map
           ("C-r" . ivy-previous-line-or-history)
           ("M-RET" . ivy-immediate-done))
     (:map counsel-find-file-map
           ("C-~" . counsel-goto-local-home)))
    :custom
    (ivy-use-virtual-buffers t)
    (ivy-height 10)
    (ivy-on-del-error-function nil)
    (ivy-magic-slash-non-match-action 'ivy-magic-slash-non-match-create)
    (ivy-count-format "ã€%d/%dã€‘")
    (ivy-wrap t)
    :config
    (defun counsel-goto-local-home ()
      "Go to the $HOME of the local machine."
      (interactive)
      (ivy--cd "~/")))


  ;; company completion framework for all text
  ;; Use M-n and M-p to select, <return> to complete or <tab> to complete the common part.
  ;; Search through the completions with C-s, C-r and C-o.
  ;; Press M-(digit) to quickly complete with one of the first 10 candidates.

  (use-package company
    :diminish company-mode
    :hook ((prog-mode LaTeX-mode latex-mode ess-r-mode) . company-mode)
    :bind
    (:map company-active-map
          ([tab] . smarter-tab-to-complete)
          ("TAB" . smarter-tab-to-complete))
    :custom
    (company-minimum-prefix-length 1)
    (company-tooltip-align-annotations t)
    (company-require-match 'never)
    ;; Don't use company in the following modes
    (company-global-modes '(not shell-mode eaf-mode))
    ;; Trigger completion immediately.
    (company-idle-delay 0.1)
    ;; Number the candidates (use M-1, M-2 etc to select completions).
    (company-show-numbers t)
    :config
    (unless clangd-p (delete 'company-clang company-backends))
    (global-company-mode 1)
    (defun smarter-tab-to-complete ()
      "Try to `org-cycle', `yas-expand', and `yas-next-field' at current cursor position.

  If all failed, try to complete the common part with `company-complete-common'"
      (interactive)
      (when yas-minor-mode
        (let ((old-point (point))
              (old-tick (buffer-chars-modified-tick))
              (func-list
               (if (equal major-mode 'org-mode) '(org-cycle yas-expand yas-next-field)
                 '(yas-expand yas-next-field))))
          (catch 'func-suceed
            (dolist (func func-list)
              (ignore-errors (call-interactively func))
              (unless (and (eq old-point (point))
                           (eq old-tick (buffer-chars-modified-tick)))
                (throw 'func-suceed t)))
            (company-complete-common))))))

  (add-hook 'after-init-hook 'global-company-mode)

  (use-package company-box
    :diminish
    :if (display-graphic-p)
    :defines company-box-icons-all-the-icons
    :hook (company-mode . company-box-mode)
    :custom
    (company-box-b
     ackends-colors nil)
    (company-box-doc-delay 0.1)
    (company-box-doc-frame-parameters '((internal-border-width . 1)
                                        (left-fringe . 3)
                                        (right-fringe . 3)))
    :config
    (with-no-warnings
      ;; Prettify icons
      (defun my-company-box-icons--elisp (candidate)
        (when (or (derived-mode-p 'emacs-lisp-mode) (derived-mode-p 'lisp-mode))
          (let ((sym (intern candidate)))
            (cond ((fboundp sym) 'Function)
                  ((featurep sym) 'Module)
                  ((facep sym) 'Color)
                  ((boundp sym) 'Variable)
                  ((symbolp sym) 'Text)
                  (t . nil)))))
      (advice-add #'company-box-icons--elisp :override #'my-company-box-icons--elisp)

      ;; Credits to Centaur for these configurations
      ;; Display borders and optimize performance
      (defun my-company-box--display (string on-update)
        "Display the completions."
        (company-box--render-buffer string on-update)

        (let ((frame (company-box--get-frame))
              (border-color (face-foreground 'font-lock-comment-face nil t)))
          (unless frame
            (setq frame (company-box--make-frame))
            (company-box--set-frame frame))
          (company-box--compute-frame-position frame)
          (company-box--move-selection t)
          (company-box--update-frame-position frame)
          (unless (frame-visible-p frame)
            (make-frame-visible frame))
          (company-box--update-scrollbar frame t)
          (set-face-background 'internal-border border-color frame)
          (when (facep 'child-frame-border)
            (set-face-background 'child-frame-border border-color frame)))
        (with-current-buffer (company-box--get-buffer)
          (company-box--maybe-move-number (or company-box--last-start 1))))
      (advice-add #'company-box--display :override #'my-company-box--display)

      (defun my-company-box-doc--make-buffer (object)
        (let* ((buffer-list-update-hook nil)
               (inhibit-modification-hooks t)
               (string (cond ((stringp object) object)
                             ((bufferp object) (with-current-buffer object (buffer-string))))))
          (when (and string (> (length (string-trim string)) 0))
            (with-current-buffer (company-box--get-buffer "doc")
              (erase-buffer)
              (insert (propertize "\n" 'face '(:height 0.5)))
              (insert string)
              (insert (propertize "\n\n" 'face '(:height 0.5)))

              ;; Handle hr lines of markdown
              ;; @see `lsp-ui-doc--handle-hr-lines'
              (with-current-buffer (company-box--get-buffer "doc")
                (let (bolp next before after)
                  (goto-char 1)
                  (while (setq next (next-single-property-change (or next 1) 'markdown-hr))
                    (when (get-text-property next 'markdown-hr)
                      (goto-char next)
                      (setq bolp (bolp)
                            before (char-before))
                      (delete-region (point) (save-excursion (forward-visible-line 1) (point)))
                      (setq after (char-after (1+ (point))))
                      (insert
                       (concat
                        (and bolp (not (equal before ?\n)) (propertize "\n" 'face '(:height 0.5)))
                        (propertize "\n" 'face '(:height 0.5))
                        (propertize " "
                                    'display '(space :height (1))
                                    'company-box-doc--replace-hr t
                                    'face `(:background ,(face-foreground 'font-lock-comment-face)))
                        (propertize " " 'display '(space :height (1)))
                        (and (not (equal after ?\n)) (propertize " \n" 'face '(:height 0.5)))))))))

              (setq mode-line-format nil
                    display-line-numbers nil
                    header-line-format nil
                    show-trailing-whitespace nil
                    cursor-in-non-selected-windows nil)
              (current-buffer)))))
      (advice-add #'company-box-doc--make-buffer :override #'my-company-box-doc--make-buffer)

      ;; Display the border and fix the markdown header properties
      (defun my-company-box-doc--show (selection frame)
        (cl-letf (((symbol-function 'completing-read) #'company-box-completing-read)
                  (window-configuration-change-hook nil)
                  (inhibit-redisplay t)
                  (display-buffer-alist nil)
                  (buffer-list-update-hook nil))
          (-when-let* ((valid-state (and (eq (selected-frame) frame)
                                         company-box--bottom
                                         company-selection
                                         (company-box--get-frame)
                                         (frame-visible-p (company-box--get-frame))))
                       (candidate (nth selection company-candidates))
                       (doc (or (company-call-backend 'quickhelp-string candidate)
                                (company-box-doc--fetch-doc-buffer candidate)))
                       (doc (company-box-doc--make-buffer doc)))
            (let ((frame (frame-local-getq company-box-doc-frame))
                  (border-color (face-foreground 'font-lock-comment-face nil t)))
              (unless (frame-live-p frame)
                (setq frame (company-box-doc--make-frame doc))
                (frame-local-setq company-box-doc-frame frame))
              (set-face-background 'internal-border border-color frame)
              (when (facep 'child-frame-border)
                (set-face-background 'child-frame-border border-color frame))
              (company-box-doc--set-frame-position frame)

              ;; Fix hr props. @see `lsp-ui-doc--fix-hr-props'
              (with-current-buffer (company-box--get-buffer "doc")
                (let (next)
                  (while (setq next (next-single-property-change (or next 1) 'company-box-doc--replace-hr))
                    (when (get-text-property next 'company-box-doc--replace-hr)
                      (put-text-property next (1+ next) 'display
                                         '(space :align-to (- right-fringe 1) :height (1)))
                      (put-text-property (1+ next) (+ next 2) 'display
                                         '(space :align-to right-fringe :height (1)))))))

              (unless (frame-visible-p frame)
                (make-frame-visible frame))))))
      (advice-add #'company-box-doc--show :override #'my-company-box-doc--show)

      (defun my-company-box-doc--set-frame-position (frame)
        (-let* ((frame-resize-pixelwise t)

                (box-frame (company-box--get-frame))
                (box-position (frame-position box-frame))
                (box-width (frame-pixel-width box-frame))
                (box-height (frame-pixel-height box-frame))
                (box-border-width (frame-border-width box-frame))

                (window (frame-root-window frame))
                ((text-width . text-height) (window-text-pixel-size window nil nil
                                                                    (/ (frame-pixel-width) 2)
                                                                    (/ (frame-pixel-height) 2)))
                (border-width (or (alist-get 'internal-border-width company-box-doc-frame-parameters) 0))

                (x (- (+ (car box-position) box-width) border-width))
                (space-right (- (frame-pixel-width) x))
                (space-left (car box-position))
                (fringe-left (or (alist-get 'left-fringe company-box-doc-frame-parameters) 0))
                (fringe-right (or (alist-get 'right-fringe company-box-doc-frame-parameters) 0))
                (width (+ text-width border-width fringe-left fringe-right))
                (x (if (> width space-right)
                       (if (> space-left width)
                           (- space-left width)
                         space-left)
                     x))
                (y (cdr box-position))
                (bottom (+ company-box--bottom (frame-border-width)))
                (height (+ text-height (* 2 border-width)))
                (y (cond ((= x space-left)
                          (if (> (+ y box-height height) bottom)
                              (+ (- y height) border-width)
                            (- (+ y box-height) border-width)))
                         ((> (+ y height) bottom)
                          (- (+ y box-height) height))
                         (t y))))
          (set-frame-position frame (max x 0) (max y 0))
          (set-frame-size frame text-width text-height t)))
      (advice-add #'company-box-doc--set-frame-position :override #'my-company-box-doc--set-frame-position))

    (when (require 'all-the-icons nil t)
      (declare-function all-the-icons-faicon 'all-the-icons)
      (declare-function all-the-icons-material 'all-the-icons)
      (declare-function all-the-icons-octicon 'all-the-icons)
      (setq company-box-icons-all-the-icons
            `((Unknown . ,(all-the-icons-material "find_in_page" :height 1.0 :v-adjust -0.2))
              (Text . ,(all-the-icons-faicon "text-width" :height 1.0 :v-adjust -0.02))
              (Method . ,(all-the-icons-faicon "cube" :height 1.0 :v-adjust -0.02 :face 'all-the-icons-purple))
              (Function . ,(all-the-icons-faicon "cube" :height 1.0 :v-adjust -0.02 :face 'all-the-icons-purple))
              (Constructor . ,(all-the-icons-faicon "cube" :height 1.0 :v-adjust -0.02 :face 'all-the-icons-purple))
              (Field . ,(all-the-icons-octicon "tag" :height 1.1 :v-adjust 0 :face 'all-the-icons-lblue))
              (Variable . ,(all-the-icons-octicon "tag" :height 1.1 :v-adjust 0 :face 'all-the-icons-lblue))
              (Class . ,(all-the-icons-material "settings_input_component" :height 1.0 :v-adjust -0.2 :face 'all-the-icons-orange))
              (Interface . ,(all-the-icons-material "share" :height 1.0 :v-adjust -0.2 :face 'all-the-icons-lblue))
              (Module . ,(all-the-icons-material "view_module" :height 1.0 :v-adjust -0.2 :face 'all-the-icons-lblue))
              (Property . ,(all-the-icons-faicon "wrench" :height 1.0 :v-adjust -0.02))
              (Unit . ,(all-the-icons-material "settings_system_daydream" :height 1.0 :v-adjust -0.2))
              (Value . ,(all-the-icons-material "format_align_right" :height 1.0 :v-adjust -0.2 :face 'all-the-icons-lblue))
              (Enum . ,(all-the-icons-material "storage" :height 1.0 :v-adjust -0.2 :face 'all-the-icons-orange))
              (Keyword . ,(all-the-icons-material "filter_center_focus" :height 1.0 :v-adjust -0.2))
              (Snippet . ,(all-the-icons-material "format_align_center" :height 1.0 :v-adjust -0.2))
              (Color . ,(all-the-icons-material "palette" :height 1.0 :v-adjust -0.2))
              (File . ,(all-the-icons-faicon "file-o" :height 1.0 :v-adjust -0.02))
              (Reference . ,(all-the-icons-material "collections_bookmark" :height 1.0 :v-adjust -0.2))
              (Folder . ,(all-the-icons-faicon "folder-open" :height 1.0 :v-adjust -0.02))
              (EnumMember . ,(all-the-icons-material "format_align_right" :height 1.0 :v-adjust -0.2))
              (Constant . ,(all-the-icons-faicon "square-o" :height 1.0 :v-adjust -0.1))
              (Struct . ,(all-the-icons-material "settings_input_component" :height 1.0 :v-adjust -0.2 :face 'all-the-icons-orange))
              (Event . ,(all-the-icons-octicon "zap" :height 1.0 :v-adjust 0 :face 'all-the-icons-orange))
              (Operator . ,(all-the-icons-material "control_point" :height 1.0 :v-adjust -0.2))
              (TypeParameter . ,(all-the-icons-faicon "arrows" :height 1.0 :v-adjust -0.02))
              (Template . ,(all-the-icons-material "format_align_left" :height 1.0 :v-adjust -0.2)))
            company-box-icons-alist 'company-box-icons-all-the-icons)))


  (use-package smart-tab)
  (require 'smart-tab)
  (global-smart-tab-mode 1)

#+end_src

** Project management

Use Projectile to handle interaction with projects

#+begin_src emacs-lisp


  ;; projectile
  (use-package projectile
    :bind
    ("C-c v" . projectile-ag)

    :config
    (define-key projectile-mode-map (kbd "C-c p") 'projectile-command-map)

    (setq projectile-switch-project-action 'projectile-dired)
    (setq projectile-require-project-root nil)
    (setq projectile-completion-system 'ivy))
  (projectile-mode +1)

  ;; treemacs

  (use-package treemacs
    :ensure t
    :defer t
    :init
    (with-eval-after-load 'winum
      (define-key winum-keymap (kbd "M-0") #'treemacs-select-window))
    :config
    (progn
      (setq treemacs-collapse-dirs                 (if treemacs-python-executable 3 0)
            treemacs-deferred-git-apply-delay      0.5
            treemacs-directory-name-transformer    #'identity
            treemacs-display-in-side-window        t
            treemacs-eldoc-display                 t
            treemacs-file-event-delay              5000
            treemacs-file-extension-regex          treemacs-last-period-regex-value
            treemacs-file-follow-delay             0.2
            treemacs-file-name-transformer         #'identity
            treemacs-follow-after-init             t
            treemacs-git-command-pipe              ""
            treemacs-goto-tag-strategy             'refetch-index
            treemacs-indentation                   2
            treemacs-indentation-string            " "
            treemacs-is-never-other-window         t
            treemacs-max-git-entries               5000
            treemacs-missing-project-action        'ask
            treemacs-move-forward-on-expand        nil
            treemacs-no-png-images                 nil
            treemacs-no-delete-other-windows       t
            treemacs-project-follow-cleanup        nil
            treemacs-persist-file                  (expand-file-name ".cache/treemacs-persist" user-emacs-directory)
            treemacs-position                      'left
            treemacs-recenter-distance             0.1
            treemacs-recenter-after-file-follow    nil
            treemacs-recenter-after-tag-follow     nil
            treemacs-recenter-after-project-jump   'always
            treemacs-recenter-after-project-expand 'on-distance
            treemacs-show-cursor                   nil
            treemacs-show-hidden-files             t
            treemacs-silent-filewatch              nil
            treemacs-silent-refresh                nil
            treemacs-sorting                       'alphabetic-asc
            treemacs-space-between-root-nodes      t
            treemacs-tag-follow-cleanup            t
            treemacs-tag-follow-delay              1.5
            treemacs-user-mode-line-format         nil
            treemacs-user-header-line-format       nil
            treemacs-width                         35
            treemacs-workspace-switch-cleanup      nil)

      ;; The default width and height of the icons is 22 pixels. If you are
      ;; using a Hi-DPI display, uncomment this to double the icon size.
      ;;(treemacs-resize-icons 44)

      (treemacs-follow-mode t)
      (treemacs-filewatch-mode t)
      (treemacs-fringe-indicator-mode t)
      (pcase (cons (not (null (executable-find "git")))
                   (not (null treemacs-python-executable)))
        (`(t . t)
         (treemacs-git-mode 'deferred))
        (`(t . _)
         (treemacs-git-mode 'simple))))
    :bind
    (:map global-map
          ("M-0"       . treemacs-select-window)
          ("C-x t 1"   . treemacs-delete-other-windows)
          ("C-x t t"   . treemacs)
          ("C-x t B"   . treemacs-bookmark)
          ("C-x t C-t" . treemacs-find-file)
          ("C-x t M-t" . treemacs-find-tag)))

  (use-package treemacs-projectile
    :after treemacs projectile
    :ensure t)

  (use-package treemacs-icons-dired
    :after treemacs dired
    :ensure t
    :config (treemacs-icons-dired-mode))

  (use-package treemacs-magit
    :after treemacs magit
    :ensure t)

  (use-package treemacs-persp ;;treemacs-persective if you use perspective.el vs. persp-mode
    :after treemacs persp-mode ;;or perspective vs. persp-mode
    :ensure t
    :config (treemacs-set-scope-type 'Perspectives))

#+end_src

** CSS Sass and Less

Configuration for CSS and related techs. Most of the stuff borrowed from https://readingworldmagazine.com/emacs/2021-01-29-emacs-css-and-scss/

#+begin_src emacs-lisp

  ;; css sort
  (use-package com-css-sort
    :commands (com-css-sort com-css-sort-attributes-block com-css-sort-attributes-document)
    :config
    (setq com-css-sort-sort-type 'alphabetic-sort)
    );end com-css-sort

  ;; css-eldoc
  (use-package css-eldoc
    :commands turn-on-css-eldoc
    ;;add a hook if you want always to see the selector options in the minibuffer
    :config
    (add-hook 'css-mode-hook 'turn-on-css-eldoc)
    (add-hook 'scss-mode-hook 'turn-on-css-eldoc)
    )                                     ;end css-eldoc

  (use-package origami
    :commands (origami-toggle-node origami-mode)
    :config
    (add-to-list 'origami-parser-alist '(scss-markers   . ,(origami-markers-parser "/*/" "/*/")))
    (add-hook 'scss-mode-hook
              (lambda () (setq-local origami-fold-style 'scss-markers)))
    :bind
    ("C-c i" . origami-toggle-node)
    );end origami mode
  (add-hook 'css-mode-hook
            (lambda ()
              (set (make-local-variable 'company-backends) '(company-capf company-css  company-dabbrev-code company-dabbrev company-etags company-yasnippet))))
  (add-hook 'css-mode-hook 'emmet-mode)
  ;;sass

  (use-package scss-mode
                                          ;:after(web-mode css-mode scss-mode)
    :commands (scss-mode scss-compile css-mode web-mode)
    :mode ("\\.scss" . scss-mode)
    :init
    (defun company-scss-mode-hook ()
      (set (make-local-variable 'company-backends) '(company-capf company-css  company-dabbrev-code company-dabbrev company-etags company-yasnippet)))
    :config
    (require 'scss-mode)
    (setq scss-compile-at-save 'nil)
    ;;(autoload 'scss-mode "scss-mode")
    ;;require company-css
    (require 'company-css)
    ;;hook

    (use-package flymake-sass)
    (require 'flymake-sass)
    :hook
    (scss-mode . (lambda ()
                   (progn
                     (highlight-indent-guides-mode -1)
                     (emmet-mode 1)
                     (company-mode 1)
                     (company-scss-mode-hook)
                     (setq emmet-preview-default -1)
                     (flymake-sass-load)
                     )));end hook
    );end scss-mode
  ;;use scss-mode

  ;; CSS Sass and Less
  (use-package css-mode
    :config
    (setq css-indent-offset 2))

  (use-package scss-mode
    :config
    (setq scss-compile-at-save nil))

  (use-package less-css-mode)

#+end_src

** Yaml

All YAML related config including AWS cloudformation, k8, & ansible.

#+begin_src emacs-lisp
  (require 'lsp-mode)

  (add-to-list 'lsp-enabled-clients 'yamlls)

  (lsp-register-client
   (make-lsp-client :new-connection (lsp-stdio-connection
                                     (lambda ()
                                       `(,(or (executable-find (cl-first lsp-yaml-server-command))
                                              (lsp-package-path 'yaml-language-server))
                                         ,@(cl-rest lsp-yaml-server-command))))
                    :major-modes '(cfn-yaml-mode docker-compose-mode dockerfile-mode )
                    :priority 1
                    :server-id 'yamlls))


  (lsp-register-client
   (make-lsp-client :new-connection (lsp-stdio-connection "erlang_ls -t stdio")
                    :major-modes '(erlang-mode)
                    :server-id 'erlang-ls))

  (add-to-list 'lsp-language-id-configuration '(cfn-yaml-mode . "spring-boot-properties-yaml"))
  (add-to-list 'lsp-language-id-configuration '(docker-compose-mode . "spring-boot-properties-yaml"))

  (use-package yaml-mode
    :ensure t
    :config
    (add-hook 'yaml-mode-hook
              'highlight-indent-guides-mode
              '(lambda ()
                 (define-key yaml-mode-map "\C-m" 'newline-and-indent)))
    (add-hook 'yaml-mode-hook 'highlight-indent-guides-mode)

    (add-to-list 'auto-mode-alist '("\\.yml$" . yaml-mode))
    (add-to-list 'auto-mode-alist '("\\.yaml$" . yaml-mode)))

  (use-package k8s-mode
    :ensure t
    :config
    (setq k8s-search-documentation-browser-function 'browse-url-firefox)
    :hook (k8s-mode . yas-minor-mode))

  ;; AWS Cloudformation linter cfn-linter
  ;; Set up a mode for YAML based templates if yaml-mode is installed
  ;; Get yaml-mode here https://github.com/yoshiki/yaml-mode
  (when (featurep 'yaml-mode)

    (define-derived-mode cfn-yaml-mode yaml-mode
      "CFN-YAML"
      "Simple mode to edit CloudFormation template in YAML format.")

    (add-to-list 'magic-mode-alist
                 '("\\(---\n\\)?AWSTemplateFormatVersion:" . cfn-yaml-mode)))

  ;; Set up cfn-lint integration if flycheck is installed
  ;; Get flycheck here https://www.flycheck.org/
  (when (featurep 'flycheck)
    (flycheck-define-checker cfn-lint
      "AWS CloudFormation linter using cfn-lint.

           Install cfn-lint first: pip install cfn-lint

           See `https://github.com/aws-cloudformation/cfn-python-lint'."

      :ensure-system-package (cfn-lint)
      :command ("cfn-lint" "-f" "parseable" source)
      :error-patterns ((warning line-start (file-name) ":" line ":" column
                                ":" (one-or-more digit) ":" (one-or-more digit) ":"
                                (id "W" (one-or-more digit)) ":" (message) line-end)
                       (error line-start (file-name) ":" line ":" column
                              ":" (one-or-more digit) ":" (one-or-more digit) ":"
                              (id "E" (one-or-more digit)) ":" (message) line-end))
      :modes (cfn-json-mode cfn-yaml-mode))

    (add-to-list 'flycheck-checkers 'cfn-lint)
    (add-hook 'cfn-json-mode-hook 'flycheck-mode)
    (add-hook 'cfn-yaml-mode-hook 'flycheck-mode))

  (use-package aws-snippets)

  ;; Ansible minor mode

  (use-package ansible)
  (add-hook 'yaml-mode-hook '(lambda () (ansible 1)))

  (setq openapi-yaml-use-yaml-mode-syntax-highlight t)

#+end_src

** Golang
Golang related configs

#+begin_src emacs-lisp


  ;; go-mode
  (add-to-list 'lsp-enabled-clients 'gopls)

  (use-package go-errcheck)
  (use-package godoctor)
  (use-package go-mode
    :config

    (define-key go-mode-map (kbd "C-c c") 'go-run))

  ;; use golangci
  (use-package flycheck-golangci-lint
    :ensure t)

  ;; (add-hook 'before-save-hook 'gofmt-before-save)

  (use-package go-projectile)
  (use-package gotest)

  ;; company-go
  (use-package company-go
    :ensure t)

  ;; TBR
  (use-package flycheck-gometalinter
    :ensure t
    :config
    (flycheck-gometalinter-setup)
    (setq flycheck-gometalinter-fast t)
    (setq flycheck-gometalinter-disable-linters '("gotype")))

  (add-hook 'go-mode-hook #'lsp-go-install-save-hooks)

  (lsp-register-custom-settings
   '(("gopls.completeUnimported" t t)
     ("gopls.staticcheck" t t)))

  ;; add go yasnippet
  (use-package go-snippets)

#+end_src

** Clojure
#+begin_src emacs-lisp


  ;; Clojure

  (use-package cider)


#+end_src

** RST (reStructured Text)
RST is a file format for textual data primarily used by Python
programming language community for technical documentation.  It's sort
of lightweight markup language

#+begin_src emacs-lisp


  ;; rst-mode
  (use-package rst
    :config
    (add-hook 'rst-mode-hook
              (lambda ()
                (local-set-key (kbd "C-M-h") 'backward-kill-word)
                (setq-local fill-column 80)
                (turn-on-auto-fill))))


#+end_src

** C, C++
cc-mode for working c, c++

#+begin_src emacs-lisp


  ;; cc-mode
  (use-package cc-mode
    :config
    (add-hook 'c-mode-common-hook
              (lambda ()
                (local-set-key (kbd "C-M-h") 'backward-kill-word)
                (local-set-key (kbd "C-c h") 'c-mark-function))))

  ;; lsp-mode for c++
  (use-package ccls

    :hook ((c-mode c++-mode objc-mode cuda-mode) .
           (lambda () (require 'ccls) (lsp))))
  (setq ccls-initialization-options '(:index (:comments 2) :completion (:detailedLabel t)))
  (setq ccls-executable "/usr/local/bin/ccls")
  ;; (setq ccls-args '("--log-file=/tmp/ccls.log"))


#+end_src

** HTML
Web-mode for working with HTML

#+begin_src emacs-lisp


  ;; web-mode
  (use-package web-mode
    :ensure t
    :mode "\\.html?\\'")

  (require 'web-mode)
  (add-to-list 'auto-mode-alist '("\\.hb\\.html\\'" . web-mode))
  (add-to-list 'auto-mode-alist '("\\.phtml\\'" . web-mode))
  (add-to-list 'auto-mode-alist '("\\.tpl\\.php\\'" . web-mode))
  (add-to-list 'auto-mode-alist '("\\.jsp\\'" . web-mode))
  (add-to-list 'auto-mode-alist '("\\.as[cp]x\\'" . web-mode))
  (add-to-list 'auto-mode-alist '("\\.erb\\'" . web-mode))
  (add-to-list 'auto-mode-alist '("\\.html\\'" . web-mode))
  (add-to-list 'auto-mode-alist '("\\.hbs\\'" . web-mode))


  ;; everything is indented 2 spaces
  (setq web-mode-markup-indent-offset 2)
  (setq web-mode-css-indent-offset 2)
  (setq web-mode-code-indent-offset 2)

  ;; Emmet Mode for HTML

  (use-package emmet-mode)
  (add-hook 'sgml-mode-hook 'emmet-mode) ;; Auto-start on any markup modes
  (add-hook 'css-mode-hook  'emmet-mode) ;; enable Emmet's css abbreviation.

  (add-hook 'web-mode-hook  'emmet-mode) ;; enable Emmet's css abbreviation.
  (add-hook 'emmet-mode-hook (lambda () (setq emmet-indentation 2))) ;; indent 2 spaces.
  (setq emmet-move-cursor-between-quotes t) ;; default nil
  (setq emmet-self-closing-tag-style " /") ;; default "/"

  (use-package skewer-mode)
  (add-hook 'js2-mode-hook 'skewer-mode)
  (add-hook 'css-mode-hook 'skewer-css-mode)
  (add-hook 'html-mode-hook 'skewer-html-mode)

  (add-hook 'web-mode-hook 'emmet-mode)
  (add-hook 'js2-mode-hook 'emmet-mode)

#+end_src

** React Nodejs Javascript
Nodejs & React stuff
#+begin_src emacs-lisp
  (add-to-list 'lsp-enabled-clients 'ts-ls)
  (add-to-list 'lsp-language-id-configuration '(js2-mode . "javascript"))

  (use-package instant-rename-tag
    :load-path (lambda () (expand-file-name "site-elisp/instant-rename-tag" user-emacs-directory))
    :bind ("C-x <" . instant-rename-tag))
  (use-package js-import)
  (use-package js2-refactor)
  (require 'js2-refactor)
  (add-hook 'js2-mode-hook #'js2-refactor-mode)
  (setq js2-skip-preprocessor-directives t)
  (js2r-add-keybindings-with-prefix "C-c C-m")
  ;; eg. extract function with `C-c C-m ef`.

  (use-package add-node-modules-path
    :defer t
    :hook (((js2-mode rjsx-mode) . add-node-modules-path)))


  (use-package prettier-js
    :defer t
    :diminish prettier-js-mode
    :hook (((js2-mode rjsx-mode) . prettier-js-mode))
    :init
    ) ; (f)ormat (p)rettier


  ;; Javascript and coffeescript
  (use-package coffee-mode)
  (add-hook 'coffee-mode-hook
            (lambda ()
              (yas-minor-mode 1)
              (setq coffee-tab-width 2)))

  (defun setup-local-standard ()
    "If standard found in node_modules directory - use that for flycheck.
            Copied from: http://www.cyrusinnovation.com/initial-emacs-setup-for-reactreactnative/"
    (interactive)
    (let ((local-standard (expand-file-name "./node_modules/.bin/standard")))
      (setq flycheck-javascript-standard-executable
            (and (file-exists-p local-standard) local-standard))))

  ;; Tern is a JavaScript analyzer
  (defun setup-local-tern ()
    "If tern found in node_modules directory - use that for tern mode."
    (interactive)
    (let ((local-tern (expand-file-name "./node_modules/.bin/tern")))
      (message local-tern)
      (and (file-exists-p local-tern)
           (defvar tern-command (list local-tern))
           (tern-mode t))))


  ;; js2-mode for javascript
  (use-package js2-mode)
  (use-package js2-refactor)
  (require 'js2-refactor)
  (add-hook 'js2-mode-hook #'js2-refactor-mode)
  (add-hook 'js-mode-hook 'js2-minor-mode)
  (add-to-list 'interpreter-mode-alist '("node" . js2-mode))
  (add-to-list 'auto-mode-alist '("\\.jsx?\\'" . js2-jsx-mode))
  (add-to-list 'interpreter-mode-alist '("node" . js2-jsx-mode))
  (add-to-list 'auto-mode-alist '("\\.js\\'"    . js2-mode))
  (setq js2-indent-level 2)

  ;; TypeScript use tide
  (use-package tide
    :ensure t
    :after (typescript-mode company flycheck)
    :hook ((typescript-mode . tide-setup)
           (typescript-mode . tide-hl-identifier-mode)
           (before-save . tide-format-before-save)))
  ;; aligns annotation to the right hand side
  (setq company-tooltip-align-annotations t)
  (setq tide-completion-ignore-case t)

  (defun setup-tide-mode ()
    (interactive)
    (tide-setup)
    (flycheck-mode +1)
    (setq flycheck-check-syntax-automatically '(save mode-enabled))
    (eldoc-mode +1)
    (tide-hl-identifier-mode +1)
    (company-mode +1))


  (add-hook 'js2-mode-hook #'setup-tide-mode)
  (add-hook 'rjsx-mode-hook #'setup-tide-mode)

  (setq tide-format-options
        '(:indentSize 2 :tabSize 2))
  ;; TSX

  (require 'web-mode)
  (add-to-list 'auto-mode-alist '("\\.tsx\\'" . web-mode))
  (add-hook 'web-mode-hook
            (lambda ()
              (when (string-equal "tsx" (file-name-extension buffer-file-name))
                (setup-tide-mode))))
  ;; enable typescript-tslint checker
  (flycheck-add-mode 'typescript-tslint 'web-mode)
  (flycheck-add-mode 'typescript-tslint 'js2-mode)
  ;; JSX
  (require 'web-mode)

  (add-to-list 'auto-mode-alist '("\\.jsx\\'" . web-mode))
  (add-hook 'web-mode-hook
            (lambda ()
              (when (string-equal "jsx" (file-name-extension buffer-file-name))
                (setup-tide-mode))))
  ;; configure jsx-tide checker to run after your default jsx checker
  (flycheck-add-mode 'javascript-eslint 'web-mode)
  ;;(flycheck-add-next-checker 'javascript-eslint 'jsx-tide 'append)

  ;; formats the buffer before saving
  (add-hook 'before-save-hook 'tide-format-before-save)
  (add-hook 'typescript-mode-hook #'setup-tide-mode)

  ;; ternjs
  (use-package tern
    :ensure t)

  (use-package js-react-redux-yasnippets)
  (use-package react-snippets)

#+end_src

** Markdown
Settings for handling markdown files

#+begin_src emacs-lisp


  ;; markdown-mode

  (use-package markdown-mode
    :commands markdown-mode
    :ensure-system-package (markdown pandoc)
    :init
    (add-hook 'markdown-mode-hook #'visual-line-mode)
    (add-hook 'markdown-mode-hook #'variable-pitch-mode)
    (add-hook 'markdown-mode-hook #'flyspell-mode)
    :config


    ;; The default command for markdown (~markdown~), doesn't support tables
    ;; (e.g. GitHub flavored markdown). Pandoc does, so let's use that.
    (setq markdown-command "pandoc --from markdown --to html")
    (setq markdown-command-needs-filename t)
    (custom-set-faces
     '(markdown-code-face ((t nil)))))


#+end_src

** Docker
Dockerfile and docker-compose related settings
#+begin_src emacs-lisp


  ;; dockerfile-mode
  (use-package dockerfile-mode
    :ensure t)

  (use-package docker)
  ;; (straight-use-package '(dockerfile-mode :type git :repo "fredeeb/dockerfile-mode"))
  (setq dockerfile-use-buildkit t)
  (use-package docker-compose-mode
    :mode ("docker-compose.yml\\'" . docker-compose-mode))
  (use-package docker-tramp
    :config (add-to-list 'tramp-remote-path 'tramp-own-remote-path))


#+end_src

** Elixir
Elixir is a dynamic functional language based of Erlang
#+begin_src emacs-lisp

  ;; elixir
  (use-package elixir-mode
    :ensure t)


#+end_src

** Protobuf
Googles Protocol Buffer files. They are some what similar to JSON
#+begin_src emacs-lisp

  ;; protobuf
  (use-package protobuf-mode
    :ensure t
    :config
    (defconst my-protobuf-style
      '((c-basic-offset . 4)
        (indent-tabs-mode . nil)))
    (add-hook 'protobuf-mode-hook
              (lambda () (c-add-style "my-style" my-protobuf-style t))))


#+end_src

** Lisp Language
List language
#+begin_src emacs-lisp



  ;; paredit you can manipulate text as a tree
  (use-package paredit)
  (autoload 'enable-paredit-mode "paredit" "Turn on pseudo-structural editing of Lisp code." t)
  (add-hook 'emacs-lisp-mode-hook       #'enable-paredit-mode)
  (add-hook 'eval-expression-minibuffer-setup-hook #'enable-paredit-mode)
  (add-hook 'ielm-mode-hook             #'enable-paredit-mode)
  (add-hook 'lisp-mode-hook             #'enable-paredit-mode)
  (add-hook 'lisp-interaction-mode-hook #'enable-paredit-mode)
  (add-hook 'scheme-mode-hook           #'enable-paredit-mode)

  ;; paredit eldoc

  (require 'eldoc) ; if not already loaded
  (eldoc-add-command
   'paredit-backward-delete
   'paredit-close-round)


  ;; Paredit SLIME
  (add-hook 'slime-repl-mode-hook (lambda () (paredit-mode +1)))
  ;; Stop SLIME's REPL from grabbing DEL,
  ;; which is annoying when backspacing over a '('
  (defun override-slime-repl-bindings-with-paredit ()
    (define-key slime-repl-mode-map
                (read-kbd-macro paredit-backward-delete-key) nil))
  (add-hook 'slime-repl-mode-hook 'override-slime-repl-bindings-with-paredit)
  ;; Paredit electric return

  (defvar electrify-return-match
    "[\]}\)\"]"
    "If this regexp matches the text after the cursor, do an \"electric\"
  return.")

  (defun electrify-return-if-match (arg)
    "If the text after the cursor matches `electrify-return-match' then
  open and indent an empty line between the cursor and the text.  Move the
  cursor to the new line."
    (interactive "P")
    (let ((case-fold-search nil))
      (if (looking-at electrify-return-match)
          (save-excursion (newline-and-indent)))
      (newline arg)
      (indent-according-to-mode)))
  ;; Using local-set-key in a mode-hook is a better idea.
  (global-set-key (kbd "RET") 'electrify-return-if-match)

  (add-hook 'emacs-lisp-mode-hook
            (lambda ()
              (paredit-mode t)
              (turn-on-eldoc-mode)
              (eldoc-add-command
               'paredit-backward-delete
               'paredit-close-round)
              (local-set-key (kbd "RET") 'electrify-return-if-match)
              (eldoc-add-command 'electrify-return-if-match)
              (show-paren-mode t)))

  (defun paredit-barf-all-the-way-backward ()
    (interactive)
    (paredit-split-sexp)
    (paredit-backward-down)
    (paredit-splice-sexp))

  (defun paredit-barf-all-the-way-forward ()
    (interactive)
    (paredit-split-sexp)
    (paredit-forward-down)
    (paredit-splice-sexp)
    (if (eolp) (delete-horizontal-space)))

  (defun paredit-slurp-all-the-way-backward ()
    (interactive)
    (catch 'done
      (while (not (bobp))
        (save-excursion
          (paredit-backward-up)
          (if (eq (char-before) ?\()
              (throw 'done t)))
        (paredit-backward-slurp-sexp))))

  (defun paredit-slurp-all-the-way-forward ()
    (interactive)
    (catch 'done
      (while (not (eobp))
        (save-excursion
          (paredit-forward-up)
          (if (eq (char-after) ?\))
              (throw 'done t)))
        (paredit-forward-slurp-sexp))))

  (nconc paredit-commands
         '("Extreme Barfage & Slurpage"
           (("C-M-)")
            paredit-slurp-all-the-way-forward
            ("(foo (bar |baz) quux zot)"
             "(foo (bar |baz quux zot))")
            ("(a b ((c| d)) e f)"
             "(a b ((c| d)) e f)"))
           (("C-M-}" "M-F")
            paredit-barf-all-the-way-forward
            ("(foo (bar |baz quux) zot)"
             "(foo (bar|) baz quux zot)"))
           (("C-M-(")
            paredit-slurp-all-the-way-backward
            ("(foo bar (baz| quux) zot)"
             "((foo bar baz| quux) zot)")
            ("(a b ((c| d)) e f)"
             "(a b ((c| d)) e f)"))
           (("C-M-{" "M-B")
            paredit-barf-all-the-way-backward
            ("(foo (bar baz |quux) zot)"
             "(foo bar baz (|quux) zot)"))))

  (paredit-define-keys)
  (paredit-annotate-mode-with-examples)
  (paredit-annotate-functions-with-examples)

  ;; FIXME Mishandles adjoining whole-line comments (reinserts preceding at end)
  (defun paredit-delete-indentation (&optional arg)
    "Handle joining lines that end in a comment."
    (interactive "*P")
    (let (comt)
      (save-excursion
        (move-beginning-of-line (if arg 1 0))
        ;; FIXME This misidentifies a semicolon inside a string as a comment
        ;; in lisp
        (when (skip-syntax-forward "^<" (point-at-eol))
          (setq comt (delete-and-extract-region (point) (point-at-eol)))))
      (delete-indentation arg)
      (when comt
        (save-excursion
          (move-end-of-line 1)
          (insert " ")
          (insert comt)))))
  (define-key paredit-mode-map (kbd "M-^") 'paredit-delete-indentation)

  (setq lispy-mode-hooks
        '(clojure-mode-hook
          emacs-lisp-mode-hook
          lisp-mode-hook
          scheme-mode-hook))

  (dolist (hook lispy-mode-hooks)
    (add-hook hook (lambda ()
                     (setq show-paren-style 'expression)
                     (paredit-mode)
                     (rainbow-delimiters-mode))))


#+end_src

** Jinja
Jinja2 mode
#+begin_src emacs-lisp


  ;; jinja2 mode, https://github.com/paradoxxxzero/jinja2-mode
  (use-package jinja2-mode)
  (add-to-list 'auto-mode-alist '("\\.jinja2\\'" . jinja2-mode))
  (add-to-list 'auto-mode-alist '("\\.j2\\'" . jinja2-mode))


#+end_src

** Terminal
terminalchanges

#+begin_src emacs-lisp


  ;; Multi-term use multiple terminal
  (use-package multi-term)
  (global-set-key (kbd "C-c t") 'multi-term)

  (defun hrs/term-paste (&optional string)
    "Paste STRING from clipboard."
    (interactive)
    (process-send-string
     (get-buffer-process (current-buf))
     (if string string (current-kill 0))))

  (add-hook 'term-mode-hook
            (lambda ()
              (goto-address-mode)
              (define-key term-raw-map (kbd "C-y") 'hrs/term-paste)
              (define-key term-raw-map (kbd "<mouse-2>") 'hrs/term-paste)
              (define-key term-raw-map (kbd "M-o") 'other-window)
              (setq yas-dont-activate t)))

  (cond
   ((string-equal system-type "windows-nt")
    (setq multi-term-program "c/Windows/System32/WindowsPowerShell/v1.g0/powershell.exe"))   ;; use powershell
   ((string-equal system-type "ms-dos")
    (setq multi-term-program "c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe"))
   ((string-equal system-type "darwin")
    (setq multi-term-program "/bin/bash"))
   ((string-equal system-type "gnu/linux")
    (setq multi-term-program "/bin/bash")));; use bash

  (autoload 'multi-term "multi-term" nil t)
  (autoload 'multi-term-next "multi-term" nil t)

  ;; only needed if you use autopair
  (add-hook 'term-mode-hook
            #'(lambda () (setq autopair-dont-activate t)))

  (global-set-key (kbd "C-c t") 'multi-term-next)
  (global-set-key (kbd "C-c T") 'multi-term) ;; create a new one


#+end_src

** Groovy
Groovy language settings
#+begin_src emacs-lisp

  ;; Jenkins
  (use-package jenkins)
  ;; groovy-mode

  (use-package groovy-mode)
  (setq-default groovy-mode 1)
  ;; enable when working on jenkins shared lib
  ;;  (add-hook 'groovy-mode-hook 'git-auto-commit-mode)
  (add-to-list 'lsp-enabled-clients 'groovy-ls)
  (setq lsp-groovy-server-file "~/groovy-language-server/groovy-language-server-all.jar")
  (add-hook 'groovy-mode-hook #'lsp-deferred)
  ;; (add-hook 'groovy-mode-hook #'lsp-groovy-enable)

  (use-package lsp-ivy :commands lsp-ivy-workspace-symbol)
  (use-package lsp-treemacs :commands lsp-treemacs-errors-list)

  ;; Git autocommit used for groovy
  (use-package git-auto-commit-mode)


#+end_src

** Java
Set Emacs as Java IDE
#+begin_src emacs-lisp

  (add-to-list 'lsp-enabled-clients 'jdtls)





  (use-package java-snippets)

  (setq c-basic-offset 4)


#+end_src

** Terraform
Terraform uses DSL.

#+begin_src emacs-lisp


  ;; Terraform mode

  (use-package terraform-mode)
  (custom-set-variables
   '(terraform-indent-level 4))


#+end_src

** Python
Cleanup needed
#+begin_src emacs-lisp

  (setq-default py-split-windows-on-execute-function 'split-window-horizontally)
  ;; python

  (use-package python-mode
    :ensure nil
    :after flycheck
    :mode "\\.py\\'"
    :custom
    (python-indent-offset 4)
    (flycheck-python-pycompile-executable "python3")
    (python-shell-interpreter "python3"))


  (use-package lsp-pyright
    :hook (python-mode . (lambda () (require 'lsp-pyright)))
    :custom
    (lsp-pyright-multi-root nil))
  (add-to-list 'lsp-enabled-clients 'pyright)

  (setq python-shell-interpreter "python3")

  (use-package py-autopep8)
  (require 'py-autopep8)
  (add-hook 'python-mode-hook 'py-autopep8-enable-on-save)

  ;; to reformat your python buffer enable blacken-mode in relevant python buffers
  (use-package blacken)

  ;; Emacs Ipython Notebook
  (use-package ein)

  (require 'ein)
  (setq ein:output-area-inlined-images t)
  (setq ein:slice-image t)

  ;; Try ein and decide if this is needed
  (use-package jupyter)

  ;; Use IPython for REPL
  (setq python-shell-completion-native-enable nil)
  ;; (setq python-shell-interpreter "jupyter-notebook"
  ;;      python-shell-interpreter-args "console"
  ;;      python-shell-prompt-detect-failure-warning nil)

  (use-package eldoc
    :config
    (add-hook 'emacs-lisp-mode-hook 'eldoc-mode))

#+end_src

** Bash/Shell
Shell script settings and opening a terminal using shell-pop
#+begin_src emacs-lisp

  ;; sh

  (require 'lsp-mode)
  (lsp-register-client
   (make-lsp-client :new-connection (lsp-stdio-connection "bash-language-server")
                    :major-modes '(sh-mode)
                    :server-id 'bash-language-server))

  (add-to-list 'lsp-enabled-clients 'bash-ls)
  (add-hook 'sh-mode-hook
            (lambda ()
              (setq sh-basic-offset 2
                    sh-indentation 2)))

  (use-package shell-pop
    :bind ("C-t" . shell-pop)
    :config
    (setq shell-pop-shell-type (quote ("ansi-term" "*ansi-term*" (lambda nil (ansi-term shell-pop-term-shell)))))
    (setq shell-pop-term-shell "/bin/bash")
    (setq shell-pop-universal-key "C-t")
    ;; need to do this manually or not picked up by `shell-pop'
    (shell-pop--set-shell-type 'shell-pop-shell-type shell-pop-shell-type))


#+end_src

** HTML PHP
Html, php, etc
#+begin_src emacs-lisp


  ;; web-mode
  (add-to-list 'lsp-enabled-clients 'html-ls)
  (add-hook 'web-mode-hook
            (lambda ()
              (rainbow-mode)
              (setq web-mode-markup-indent-offset 2)))
  (lsp-register-client
   (make-lsp-client :new-connection (lsp-stdio-connection "html-languageserver")
                    :major-modes '(web-mode)
                    :server-id 'html-ls))

  (hrs/add-auto-mode
   'web-mode
   "\\.erb$"
   "\\.html$"
   "\\.php$"
   "\\.rhtml$")


#+end_src

** Json
#+begin_src emacs-lisp


  ;; Json mode

  (use-package json-mode)

  ;;(require 'flycheck-swagger-tools)


#+end_src

** Lisp
Emacs lisp or elisp programming
#+begin_src emacs-lisp
  (add-hook 'emacs-lisp-mode-hook
            (lambda ()
              ;; Use spaces, not tabs.
              (setq indent-tabs-mode nil)
              ;; Keep M-TAB for `completion-at-point'
              (define-key flyspell-mode-map "\M-\t" nil)
              ;; Pretty-print eval'd expressions.
              (define-key emacs-lisp-mode-map
                          "\C-x\C-e" 'pp-eval-last-sexp)
              ;; Recompile if .elc exists.
              ;; (add-hook (make-local-variable 'after-save-hook)
              ;;           (lambda ()
              ;;             (byte-force-recompile default-directory)))
              (define-key emacs-lisp-mode-map
                          "\r" 'reindent-then-newline-and-indent)))
  (add-hook 'emacs-lisp-mode-hook 'eldoc-mode)
  (add-hook 'emacs-lisp-mode-hook 'flyspell-prog-mode) ;; Requires Ispell
#+end_src

** Csharp
#+begin_src emacs-lisp

  (use-package tree-sitter :ensure t)
  (use-package tree-sitter-langs :ensure t)

  (use-package csharp-mode
    :ensure t
    :config
    (add-to-list 'auto-mode-alist '("\\.cs\\'" . csharp-tree-sitter-mode)))
  (add-to-list 'lsp-enabled-clients 'csharp)

#+end_src

* OrgMode
Settings for OrgMode
#+begin_src emacs-lisp


  ;; Encryption using epa https://orgmode.org/worg/org-tutorials/encrypting-files.html

  (epa-file-enable)

  ;; knowledge management with org-roam
  (use-package org-roam
    :ensure t
    :bind (("C-c n l" . org-roam-buffer-toggle)
           ("C-c n f" . org-roam-node-find)
           ("C-c n g" . org-roam-graph)
           ("C-c n i" . org-roam-node-insert)
           ("C-c n c" . org-roam-capture)
           ;; Dailies
           ("C-c n j" . org-roam-dailies-capture-today))
    :config
    (org-roam-setup)
    ;; If using org-roam-protocol
    (require 'org-roam-protocol))
  (setq org-roam-directory (file-truename "~/Documents/org-roam/"))
  (setq org-roam-dailies-directory "daily/")

  (setq org-roam-dailies-capture-templates
        '(("d" "default" entry
           "* %?"
           :if-new (file+head "%<%Y-%m-%d>.org"
                              "#+title: %<%Y-%m-%d>\n"))))
  (setq org-roam-v2-ack t)
  (setq org-roam-db-update-method 'immediate)

  (setq org-roam-completion-system 'ivy)

  (use-package org-bullets
    :init
    (add-hook 'org-mode-hook 'org-bullets-mode))


  ;; org-bars
  (quelpa '(org-bars :fetcher github
                     :repo  "tonyaldon/org-bars"
                     :files ("*")))

  (require 'org-bars)
  (add-hook 'org-mode-hook #'org-bars-mode)

  ;; Confluence exporter download from
  ;; https://github.com/aspiers/orgmode/blob/master/contrib/lisp/ox-confluence.el
  ;; and put it in ~/.emacs.d/

  (use-package ox-confluence
    :defer 3
    :ensure nil
    :after org)

  (use-package ox-gfm :defer t)
  (setq org-jira-custom-jqls
        '(
          ;; (:jql "Assignee = anuj.kulkarni AND status not in (Resolved, Closed) ORDER BY created DESC"
          ;;       :limit 100
          ;;       :filename "anuj")

          ;; (:jql "Assignee = tamanna.gupta AND status not in (Resolved, Closed) ORDER BY created DESC"
          ;;       :limit 100
          ;;       :filename "tamanna")

          ;; (:jql "Assignee = vivek.saini AND status not in (Resolved, Closed) ORDER BY created DESC"
          ;;       :limit 100
          ;;       :filename "vivek")

          ;; (:jql "Assignee = vaibhav.kamble AND status not in (Resolved, Closed) ORDER BY created DESC"
          ;;       :limit 100
          ;;       :filename "vaibhav")

          ;; (:jql "Assignee = jitendra.panchal AND status not in (Resolved, Closed) ORDER BY created DESC"
          ;;       :limit 100
          ;;       :filename "jitendra")

          (:jql "project=\"ConnectWise DevOps\" AND status not in (Resolved, Closed) ORDER BY created DESC"
                :startIndex
                :limit 10
                :filename "cw_cd")
          ))

  (use-package org-jira)

  ;;(make-directory "~/.org-jira")
  (setq jiralib-url "https://jira.connectwisedev.com")

  (setq initial-major-mode 'org-mode)
  (setq org-ellipsis "â¤µ")
  (setq org-src-fontify-natively t)
  (setq org-src-tab-acts-natively t)
  (setq org-src-window-setup 'current-window)
  (add-to-list 'org-structure-template-alist
               '("el" . "src emacs-lisp"))
  (setq org-adapt-indentation nil)

  (setq org-directory "~/Documents/org-roam")

  (define-key org-mode-map (kbd "C-c C-x C-s") 'hrs/mark-done-and-archive)

  (setq org-log-done 'time)

  ;; org-mode
  (use-package org-contrib)
  (use-package org
    :config
    (require 'org-tempo)
    (add-hook 'org-mode-hook
              '(lambda ()
                 (setq mailcap-mime-data '())
                 (mailcap-parse-mailcap "~/.mailcap")
                 (setq org-file-apps
                       '((remote . emacs)
                         ("mobi" . "fbreader %s")
                         (system . mailcap)
                         ("org" . emacs)
                         (t . mailcap))))))

  (setq org-refile-use-outline-path t)
  (setq org-outline-path-complete-in-steps nil)

  (define-key global-map "\C-cl" 'org-store-link)
  (define-key global-map "\C-ca" 'org-agenda)
  (define-key global-map "\C-cc" 'org-capture)

  ;; exporters for markdown and beamer format

  (use-package ox-md
    :ensure nil
    :defer 3
    :after org)

  (use-package ox-beamer
    :ensure nil
    :defer 3
    :after org)
  (setq org-enforce-todo-dependencies t)
  (setq org-enforce-todo-checkbox-dependencies t)

  (defvar org-agenda-start-on-weekday nil)

  (defun org-file-path (filename)
    "Return the absolute address of an org FILENAME, given its relative name."
    (concat (file-name-as-directory org-directory) filename))

  (defvar org-inbox-file "~/sync/Dropbox/inbox.org")
  (defvar org-index-file (org-file-path "index.org"))
  (setq org-archive-location
        (concat (org-file-path "archive.org") "::* From %s"))


  (setq org-agenda-sorting-strategy '(habit-down category-up))
  (setq org-agenda-files
        (seq-filter (lambda(x) (not (string-match "/org/"(file-name-directory x))))
                    (directory-files-recursively "~/Documents/org-roam" "\\.org$")
                    ))

  (use-package vulpea)

  (setq org-agenda-prefix-format
        '((agenda . " %i %(vulpea-agenda-category 12)%?-12t% s")
          (todo . " %i %(vulpea-agenda-category 12) ")
          (tags . " %i %(vulpea-agenda-category 12) ")
          (search . " %i %(vaulpea-agenda-category 12) ")))

  (defun vulpea-agenda-category (&optional len)
    "Get category of item at point for agenda.

              Category is defined by one of the following items:

              - CATEGORY property
              - TITLE keyword
              - TITLE property
              - filename without directory and extension

              When LEN is a number, resulting string is padded right with
              spaces and then truncated with ... on the right if result is
              longer than LEN.

              Usage example:

                (setq org-agenda-prefix-format
                  '((agenda . \" %(vulpea-agenda-category) %?-12t %12s\")))

              Refer to `org-agenda-prefix-format' for more information."
    (let* ((file-name (when buffer-file-name
                        (file-name-sans-extension
                         (file-name-nondirectory buffer-file-name))))
           (title (vulpea-buffer-prop-get "title"))
           (category (org-get-category))
           (result
            (or (if (and
                     title
                     (string-equal category file-name))
                    title
                  category)
                "")))
      (if (numberp len)
          (s-truncate len (s-pad-right len " " result))
        result)))

  (defun vulpea-ensure-filetag ()
    "Add respective file tag if it's missing in the current note."
    (interactive)
    (let ((tags (vulpea-buffer-tags-get))
          (tag (vulpea--title-as-tag)))
      (when (and (seq-contains-p tags "people")
                 (not (seq-contains-p tags tag)))
        (vulpea-buffer-tags-add tag))))

  (defun vulpea--title-as-tag ()
    "Return title of the current note as tag."
    (vulpea--title-to-tag (vulpea-buffer-title-get)))

  (defun vulpea--title-to-tag (title)
    "Convert TITLE to tag."
    (concat "@" (s-replace " " "" title)))

  (defun vulpea-tags-add ()
    "Add a tag to current note."
    (interactive)
    ;; since https://github.com/org-roam/org-roam/pull/1515
    ;; `org-roam-tag-add' returns added tag, we could avoid reading tags
    ;; in `vulpea-ensure-filetag', but this way it can be used in
    ;; different contexts while having simple implementation.
    (when (call-interactively #'org-roam-tag-add)
      (vulpea-ensure-filetag)))


  (defun vulpea-insert ()
    "Insert a link to the note."
    (interactive)
    (when-let*
        ((node (org-roam-node-insert))
         (title (org-roam-node-title node))
         (tags (org-roam-node-tags node)))
      (when (seq-contains-p tags "people")
        (save-excursion
          (ignore-errors
            (org-back-to-heading)
            (org-set-tags
             (seq-uniq
              (cons
               (vulpea--title-to-tag title)
               (org-get-tags nil t)))))))))


              ;;;; https://d12frosted.io/posts/2020-06-25-task-management-with-roam-vol3.html
  (defun hrs/mark-done-and-archive ()
    "Mark the state of an `org-mode' item as DONE and archive it."
    (interactive)
    (org-todo 'done)
    (org-archive-subtree))

  (require 'org-habit)

  (defun org-habit-build-graph (habit starting current ending)
    "Build graph with HABIT STARTING CURRENT ENDING.")
  (setq org-habit-graph-column 60)

  (setq org-agenda-custom-commands
        '(("p" "Personal agenda"
           ((tags ":today:" ((org-agenda-overriding-header "Today's tasks:")))
            (agenda "")
            (todo "TODO"
                  ((org-agenda-skip-function '(or (hrs/org-skip-subtree-if-priority ?A)
                                                  (hrs/org-skip-subtree-if-habit)))
                   (org-agenda-overriding-header "Other tasks:")))
            (todo "PENDING"
                  ((org-agenda-skip-function '(hrs/org-skip-subtree-if-priority ?A))
                   (org-agenda-overriding-header "Pending:")))
            (todo "BLOCKED"
                  ((org-agenda-skip-function '(hrs/org-skip-subtree-if-priority ?A))
                   (org-agenda-overriding-header "Blocked:")))))))


  (org-babel-do-load-languages
   'org-babel-load-languages
   '((emacs-lisp . t)
     (ruby . t)
     (dot . t)
     (gnuplot . t)))

  (setq org-confirm-babel-evaluate nil)
  (use-package htmlize)

  (use-package graphviz-dot-mode)
  (add-to-list 'org-src-lang-modes '("dot" . graphviz-dot))

  (setq org-export-with-smart-quotes t)

  (setq org-html-postamble nil)

  (setq browse-url-browser-function 'browse-url-generic
        browse-url-generic-program "/Applications/Safari.app/Contents/MacOS/Safari")

  (setenv "BROWSER" "/Applications/Safari.app/Contents/MacOS/Safari")
  ;; Uses more memory; see https://github.com/politza/pdf-tools/issues/51


  (use-package pdf-tools)
  (setq pdf-view-midnight-colors '("#f8f8f2" . "#282a36"))
  ;; (pdf-view-midnight-minor-mode)

  (pdf-tools-install)
  (setq pdf-view-use-scaling t
        pdf-view-use-imagemagick nil)
  (setq org-latex-pdf-process
        '("xelatex -shell-escape -interaction nonstopmode -output-directory %o %f"
          "xelatex -shell-escape -interaction nonstopmode -output-directory %o %f"
          "xelatex -shell-escape -interaction nonstopmode -output-directory %o %f"))

  (add-to-list 'org-latex-packages-alist '("" "minted"))
  (setq org-latex-listings 'minted)

  (defvar TeX-parse-self t)
  (defvar TeX-PDF-mode t)

  (add-hook 'LaTeX-mode-hook
            (lambda ()
              (LaTeX-math-mode)
              (defvar TeX-master t)))

  (add-hook 'git-commit-mode-hook 'orgtbl-mode)
  (add-hook 'markdown-mode-hook 'orgtbl-mode)
  (add-hook 'message-mode-hook 'orgtbl-mode)

  ;; Provides support for list types like checkbox, bullets & counter cookies
  (use-package orgalist
    :config
    (add-hook 'git-commit-mode-hook 'orgalist-mode)
    (add-hook 'markdown-mode-hook 'orgalist-mode)
    (add-hook 'message-mode-hook 'orgalist-mode))

  ;; Plantuml a major mode for generating sequence and UML diagram using
  ;; text. https://plantuml.com


  (use-package plantuml-mode
    :defer t
    :custom
    (org-plantuml-jar-path (expand-file-name "/usr/local/Cellar/plantuml/1.2021.10/libexec/plantuml.jar"))
    :config
    (org-babel-do-load-languages
     'org-babel-load-languages
     '(;; other Babel languages
       (plantuml . t))))


  ;; Enable plantuml-mode for PlantUML files
  (add-to-list 'auto-mode-alist '("\\.plantuml\\'" . plantuml-mode))

  ;; org mode end


#+end_src

* Prose Writing
Mode for writing books
#+begin_src emacs-lisp

  ;; Proselint

  (defvar prose-modes
    '(gfm-mode
      git-commit-mode
      markdown-mode
      message-mode
      mu4e-compose-mode
      org-mode
      text-mode))

  (defvar prose-mode-hooks
    (mapcar (lambda (mode) (intern (format "%s-hook" mode)))
            prose-modes))

  (require 'flycheck)

  (flycheck-def-executable-var proselint "proselint")
  (flycheck-define-command-checker 'proselint
    "A linter for prose."
    :command '("proselint" source-inplace)
    :error-patterns
    '((warning line-start (file-name) ":" line ":" column ": "
               (id (one-or-more (not (any " "))))
               (message (one-or-more not-newline)
                        (zero-or-more "\n" (any " ") (one-or-more not-newline)))
               line-end))
    :modes prose-modes
    :next-checkers 'nil
    :standard-input 'nil
    :working-directory 'nil)

  (add-to-list 'flycheck-checkers 'proselint)

  (dolist (hook prose-mode-hooks)
    (add-hook hook 'flycheck-mode))

#+end_src

* Navigation

#+begin_src emacs-lisp


  ;; then define packages you use
  (use-package ace-jump-mode
    :bind ("M-SPC" . ace-jump-mode))


  ;; avy
  (use-package avy
    :bind*
    ("C-;" . avy-goto-char-2))


#+end_src

* Experimental stuff
#+begin_src emacs-lisp

  (use-package ibuffer
    :ensure nil
    :bind ("C-x C-b" . ibuffer)
    :init
    (use-package ibuffer-vc
      :commands (ibuffer-vc-set-filter-groups-by-vc-root)
      :custom
      (ibuffer-vc-skip-if-remote 'nil))
    :custom
    (ibuffer-formats
     '((mark modified read-only locked " "
             (name 35 35 :left :elide)
             " "
             (size 9 -1 :right)
             " "
             (mode 16 16 :left :elide)
             " " filename-and-process)
       (mark " "
             (name 16 -1)
             " " filename))))


  (quelpa '(eaf :fetcher github
                :repo  "emacs-eaf/emacs-application-framework"
                :files ("*")))

  (quelpa '(s :fetcher github
              :repo  "magnars/s.el"
              :files ("*")))

  (add-to-list 'load-path "/Users/gattu/.emacs.d/site-lisp/")

  (use-package eaf
    :load-path (lambda () (expand-file-name "site-lisp/emacs-application-framework" user-emacs-directory))
    :defer t
    :custom
    (browse-url-browser-function #'eaf-open-browser) ;; Make EAF Browser my default browser
    (eaf-browser-continue-where-left-off nil)
    (eaf-browse-blank-page-url "https://duckduckgo.com")
    (eaf-browser-enable-adblocker t)
    (eaf-start-python-process-when-require t)
    (eaf-browser-default-zoom 1)
    (eaf-browser-dark-mode t)
    (eaf-browser-enable-adblocker t)
    (eaf-pdf-dark-mode t)
    (eaf-browser-enable-autofill t)
    (eaf-file-manager-show-preview nil)
    :demand
    :bind
    (("C-x j" . eaf-open-in-file-manager))
    :config
    (require 'eaf-file-manager nil t)
    (require 'eaf-music-player nil t)
    (require 'eaf-image-viewer nil t)
    (require 'eaf-camera nil t)
    (require 'eaf-demo nil t)
    (require 'eaf-airshare nil t)
    (require 'eaf-terminal nil t)
    (require 'eaf-markdown-previewer nil t)
    (require 'eaf-video-player nil t)
    (require 'eaf-vue-demo nil t)
    (require 'eaf-file-sender nil t)
    (require 'eaf-pdf-viewer nil t)
    (require 'eaf-mindmap nil t)
    (require 'eaf-netease-cloud-music nil t)
    (require 'eaf-jupyter nil t)
    (require 'eaf-org-previewer nil t)
    (require 'eaf-system-monitor nil t)
    (require 'eaf-file-browser nil t)
    (require 'eaf-browser nil t)
    (require 'eaf-org)
    (require 'eaf-mail)
    (require 'eaf-all-the-icons)
    (defalias 'browse-web #'eaf-open-browser))


  ;; A game to practice speed typing in emacs
  (use-package speed-type
    :commands (speed-type-text))

  ;; hacker news
  (use-package hackernews
    :commands (hackernews)
    :bind
    (("C-c h" . hackernews)
     ("C-c m" . hackernews)))


  ;; 2048 Game

  (use-package 2048-game
    :commands (2048-game))

  ;; Mongodb
  (use-package inf-mongo)
  (add-to-list 'load-path "~/.emacs.d/vendor/inf-mongo")
  (require 'inf-mongo)
  (defvar inf-mongo-mode-map
    (let ((map (make-sparse-keymap)))
      (define-key map (kbd "C-x C-e")  'mongo-send-region)
      (define-key map (kbd "<M-up>")   'comint-previous-input)
      (define-key map (kbd "<M-down>") 'comint-next-input)
      map))

  ;; popup a frame at point
  (use-package posframe)

  ;; gnuplot is a command line driven graphing utility for linux
  (use-package gnuplot)


  ;; Ledger double entry accounting tools

  (use-package ledger-mode
    :ensure t
    :init
    (setq ledger-clear-whole-transactions 1)
    :mode "\\.dat\\'")

  (use-package emr)

  ;; sml-mode Standard ML a functional language
  (use-package sml-mode
    :ensure t)

  ;; elfeed
  (use-package elfeed
    :custom
    (elfeed-feeds
     '(
       ;;dev.to
       "http://dev.to/feed"

       ;;reddit
       "http://reddit.com/r/clojure/.rss"
       "http://reddit.com/r/cpp/.rss"
       "http://reddit.com/r/emacs/.rss"
       "http://reddit.com/r/golang/.rss"
       "http://reddit.com/r/rust/.rss"
       "http://reddit.com/r/bindingofisaac/.rss"

       ;;hackernews
       "https://news.ycombinator.com/rss"

       ;;other blogs
       "https://cestlaz.github.io/rss.xml"
       )))

  ;; Generic emacs stuff

  (defalias 'qrr 'query-regexp-replace)

  (custom-set-variables
   ;; custom-set-variables was added by Custom.
   ;; If you edit it by hand, you could mess it up, so be careful.
   ;; Your init file should contain only one such instance.
   ;; If there is more than one, they won't work right.
   '(package-selected-packages
     (quote
      (protobuf-mode elixir-mode dockerfile-mode expand-region markdown-mode flycheck-gometalinter switch-window go-guru go-rename avy company-go whole-line-or-region undo-tree web-mode go-eldoc go-direx go-add-tags go-mode yaml-mode counsel projectile ivy ag gitignore-mode magit ace-jump-mode use-package))))
  (custom-set-faces
   ;; custom-set-faces was added by Custom.
   ;; If you edit it by hand, you could mess it up, so be careful.
   ;; Your init file should contain only one such instance.
   ;; If there is more than one, they won't work right.
   )

  (defun goto-last-heading ()
    (interactive)
    (org-end-of-subtree))

  ;; not sure about this
  (use-package let-alist)

  (use-package flycheck-package)
  (eval-after-load 'flycheck
    '(flycheck-package-setup))

#+end_src

** Dictionary Update
Using StarDict
#+begin_src emacs-lisp


  ;; Dictionary

  (defun hrs/dictionary-prompt ()
    "Dictionary prompt."
    (read-string
     (format "Word (%s): " (or (hrs/region-or-word) ""))
     nil
     nil
     (hrs/region-or-word)))

  (defun hrs/dictionary-define-word ()
    "Define dictionary word."
    (interactive)
    (let* ((word (hrs/dictionary-prompt))
           (buffer-name (concat "Definition: " word)))
      (with-output-to-temp-buffer buffer-name
        (shell-command (format "sdcv -n %s" word) buffer-name))))

  (define-key global-map (kbd "C-x w") 'hrs/dictionary-define-word)


#+end_src

* Disabled
I probably don't need these

#+begin_src emacs-lisp


  ;; (use-package hydra
  ;;   :ensure t
  ;;   :config
  ;;   (require 'hydra)
  ;;   (require 'dap-mode)
  ;;   (require 'dap-ui)
  ;;   ;;:commands (ace-flyspell-setup)
  ;;   :bindp
  ;;   ;;("M-s" . hydra-go/body)
  ;;   :init
  ;;   (add-hook 'dap-stopped-hook
  ;;            (lambda (arg) (call-interactively #'hydra-go/body)))
  ;;   :hydra  (hydra-go (:color pink :hint nil :foreign-keys run)
  ;;                    "
  ;;    _n_: Next       _c_: Continue _g_: goroutines      _i_: break log
  ;;    _s_: Step in    _o_: Step out _k_: break condition _h_: break hit condition
  ;;    _Q_: Disconnect _q_: quit     _l_: locals
  ;;    "
  ;;                    ("n" dap-next)
  ;;                    ("c" dap-continue)
  ;;                    ("s" dap-step-in)
  ;;                    ("o" dap-step-out)
  ;;                    ("g" dap-ui-sessions)
  ;;                    ("l" dap-ui-locals)
  ;;                    ("e" dap-eval-thing-at-point)
  ;;                    ("h" dap-breakpoint-hit-condition)
  ;;                    ("k" dap-breakpoint-condition)
  ;;                    ("i" dap-breakpoint-log-message)
  ;;                    ("q" nil "quit" :color blue)
  ;;                    ("Q" dap-disconnect :color red)))

#+end_src

#+RESULTS:
